<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>ì²­ë‘ & ì‹œì•ˆ ì—¬í–‰ (Clean)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; background-color: #f8f9fa; padding-bottom: 100px; padding-top: env(safe-area-inset-top); user-select: none; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ğŸ¨ íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼ (ì‹±ê¸€ ì»¬ëŸ¼) */
        .timeline-container { position: relative; padding: 10px 0; }
        
        /* ì„  ìœ„ì¹˜: ì™¼ìª½ 30px ì§€ì ì— ê³ ì • (ëª¨ë°”ì¼/PC ë™ì¼) */
        .timeline-line { position: absolute; left: 29px; top: 10px; bottom: 0; width: 2px; background-color: #e5e7eb; z-index: 0; }

        .active-tab { border-bottom: 3px solid #ef4444; color: #ef4444; font-weight: 800; }
        .inactive-tab { color: #9ca3af; font-weight: 500; }
        
        /* ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ */
        .schedule-card { transition: transform 0.2s, box-shadow 0.2s; }
        .schedule-card:active { transform: scale(0.99); }
        @media (min-width: 768px) {
            .schedule-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @media print {
            body > * { display: none !important; }
            #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 40px; }
            #print-area * { visibility: visible; }
            .print-item { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; break-inside: avoid; }
            .print-time { font-weight: bold; width: 80px; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen relative">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40 w-full backdrop-blur-md bg-white/90">
        <div class="max-w-4xl mx-auto">
            <div class="px-5 py-4 flex justify-between items-center border-b border-gray-100">
                <div>
                    <h1 class="text-xl md:text-2xl font-extrabold text-gray-900 tracking-tight">ì²­ë‘ & ì‹œì•ˆ <span id="liveBadge" class="text-[10px] text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded align-top font-normal ml-1">OFFLINE</span></h1>
                    <p class="text-xs md:text-sm text-gray-500 font-medium mt-0.5">
                        <span id="totalDays">6ë°• 7ì¼</span> Â· 
                        <span id="syncStatus" class="text-gray-300 text-[11px]"><i class="fa-solid fa-circle-notch fa-spin"></i> ì—°ê²° ì¤‘...</span>
                    </p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openSettingsModal()" class="w-10 h-10 rounded-full bg-gray-50 text-gray-600 flex items-center justify-center transition hover:bg-gray-200 border border-gray-100">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex border-b border-gray-200 bg-white">
                <button onclick="switchTab('list')" class="flex-1 py-3.5 text-sm md:text-base text-center transition" id="tabList">ğŸ“… ì¼ì •í‘œ</button>
                <button onclick="switchTab('wishlist')" class="flex-1 py-3.5 text-sm md:text-base text-center transition" id="tabWishlist">ğŸ’– ë³´ê´€í•¨ (<span id="wishlistCount">0</span>)</button>
            </div>

            <div id="dateNavWrapper" class="overflow-x-auto hide-scrollbar bg-white shadow-sm transition-all duration-300">
                <div class="flex px-4 py-3 md:justify-center min-w-max gap-2" id="dateNav"></div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="schedule-container" class="p-4 md:p-8 min-h-[60vh] pb-32 max-w-4xl mx-auto transition-all duration-300"></main>
    
    <div id="print-area" class="hidden"></div>

    <!-- FAB -->
    <div id="fabAdd" class="fixed bottom-8 right-6 md:right-[calc((100vw-56rem)/2+2rem)] z-30 hidden">
        <button onclick="handleAddButton()" class="bg-blue-600 text-white w-14 h-14 md:w-16 md:h-16 rounded-full shadow-xl flex items-center justify-center hover:bg-blue-700 transition transform active:scale-95 hover:scale-105 hover:shadow-2xl">
            <i class="fa-solid fa-plus text-2xl"></i>
        </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-gray-100 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-600 font-bold text-lg">ì—¬í–‰ ì¤€ë¹„ ì¤‘...</p>
    </div>

    <!-- Modals -->
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 animate-fade-in shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-900">ì„¤ì •</h3>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-3">
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                    <h4 class="text-sm font-bold text-blue-800 mb-1">ğŸ’¾ ë°ì´í„° ë°±ì—…</h4>
                    <button onclick="downloadBackup()" class="w-full bg-white border border-blue-200 text-blue-600 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-50 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download"></i> ë‚´ ê¸°ê¸°ì— ì €ì¥
                    </button>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <h4 class="text-sm font-bold text-gray-800 mb-1">â™»ï¸ ë°ì´í„° ë³µì›</h4>
                    <label class="w-full block bg-white border border-gray-300 text-gray-600 py-2.5 rounded-lg text-sm font-bold text-center hover:bg-gray-100 cursor-pointer flex items-center justify-center gap-2">
                        <i class="fa-solid fa-upload"></i> ë°±ì—… íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
                        <input type="file" id="backupFile" accept=".json" class="hidden" onchange="restoreBackup(this)">
                    </label>
                </div>
                <button onclick="printFullSchedule()" class="w-full py-3 text-gray-700 font-bold text-sm bg-white border border-gray-300 rounded-xl hover:bg-gray-50 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-print"></i> ì „ì²´ ì¼ì • ì¸ì‡„ (PDF)
                </button>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-100 text-center"><p class="text-[10px] text-gray-400">Ver 6.0 (Single Column)</p></div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm md:max-w-md p-6 animate-fade-in shadow-2xl">
            <div class="flex justify-between items-start mb-5">
                <div>
                    <h3 class="text-xl font-bold text-gray-900 leading-tight" id="modalTitle">ì¥ì†Œ</h3>
                    <p class="text-sm text-gray-500 mt-1 font-medium" id="modalChnName">ì¤‘êµ­ì–´</p>
                </div>
                <button onclick="closeMapModal()" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="mapActions" class="space-y-3"></div>
            <button onclick="copyChnName()" class="w-full mt-4 py-3.5 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-xl font-bold hover:bg-gray-100 transition flex items-center justify-center gap-2">
                <i class="fa-regular fa-copy"></i> ì¤‘êµ­ì–´ ì§€ëª… ë³µì‚¬
            </button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-end sm:items-center justify-center sm:px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md md:max-w-lg rounded-t-2xl sm:rounded-2xl p-6 animate-slide-up sm:animate-fade-in h-[85vh] sm:h-auto overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-xl font-bold text-gray-900" id="editModalTitle">ì¶”ê°€</h3>
                <button onclick="closeEditModal()" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div id="wishlistImportSection" class="mb-6 hidden">
                <button onclick="toggleWishlistPicker()" class="w-full flex items-center justify-between bg-red-50 text-red-600 p-4 rounded-xl border border-red-100 hover:bg-red-100 transition group">
                    <span class="font-bold text-sm flex items-center"><i class="fa-solid fa-heart mr-2 group-hover:scale-110 transition-transform"></i>ë³´ê´€í•¨ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
                <div id="wishlistPicker" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-48 overflow-y-auto p-2 space-y-1 z-10"></div>
            </div>

            <form id="editForm" onsubmit="saveItem(event)" class="space-y-4">
                <input type="hidden" id="editItemId"><input type="hidden" id="editItemMode">
                
                <div class="grid grid-cols-3 gap-3" id="timeInputGroup">
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1.5 ml-1">ì‹œê°„</label>
                        <input type="text" id="editTime" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 text-center font-semibold focus:ring-2 focus:ring-blue-500 focus:bg-white transition outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 mb-1.5 ml-1">ì•„ì´ì½˜</label>
                        <select id="editIcon" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 focus:bg-white transition outline-none">
                            <option value="fa-location-dot">ğŸ“ ì¥ì†Œ</option><option value="fa-utensils">ğŸ´ ì‹ì‚¬</option><option value="fa-hotel">ğŸ¨ ìˆ™ì†Œ</option><option value="fa-plane">âœˆï¸ ê³µí•­</option><option value="fa-train">ğŸš„ ê¸°ì°¨</option><option value="fa-camera">ğŸ“· ê´€ê´‘</option><option value="fa-bag-shopping">ğŸ›ï¸ ì‡¼í•‘</option><option value="fa-coffee">â˜• ì¹´í˜</option>
                        </select>
                    </div>
                </div>
                
                <div id="iconOnlyGroup" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 mb-1.5 ml-1">ì•„ì´ì½˜</label>
                    <select id="editIconOnly" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 focus:bg-white transition outline-none" onchange="document.getElementById('editIcon').value = this.value">
                        <option value="fa-location-dot">ğŸ“ ì¥ì†Œ</option><option value="fa-utensils">ğŸ´ ì‹ì‚¬</option><option value="fa-hotel">ğŸ¨ ìˆ™ì†Œ</option><option value="fa-plane">âœˆï¸ ê³µí•­</option><option value="fa-train">ğŸš„ ê¸°ì°¨</option><option value="fa-camera">ğŸ“· ê´€ê´‘</option><option value="fa-bag-shopping">ğŸ›ï¸ ì‡¼í•‘</option><option value="fa-coffee">â˜• ì¹´í˜</option></select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1.5 ml-1">ì¥ì†Œëª… (í•œê¸€)</label>
                    <input type="text" id="editTitle" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 focus:bg-white transition outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1.5 ml-1">ì¥ì†Œëª… (ì¤‘êµ­ì–´)</label>
                    <input type="text" id="editChnName" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 focus:bg-white transition outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1.5 ml-1">ì„¤ëª…</label>
                    <textarea id="editDesc" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 focus:bg-white transition outline-none"></textarea>
                </div>
                
                <div class="border border-gray-100 rounded-xl p-4 bg-gray-50">
                    <p class="text-xs font-bold text-gray-500 mb-2">ğŸ—ºï¸ ì§€ë„ ì„¤ì •</p>
                    <div class="mb-3"><input type="url" id="editMapUrl" placeholder="ì§€ë„ ë§í¬ (URL)" class="w-full bg-white border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-1 focus:ring-blue-300 outline-none"></div>
                    <details class="text-xs text-gray-500"><summary class="cursor-pointer hover:text-blue-600 font-medium">ì¢Œí‘œ ì§ì ‘ ì…ë ¥</summary><div class="grid grid-cols-2 gap-2 mt-2"><input type="number" step="any" id="editLat" placeholder="ìœ„ë„" class="bg-white border p-2.5 rounded-lg"><input type="number" step="any" id="editLng" placeholder="ê²½ë„" class="bg-white border p-2.5 rounded-lg"></div></details>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-100 text-gray-600 py-3.5 rounded-xl font-bold text-base hover:bg-gray-200 transition">ì·¨ì†Œ</button>
                    <button type="submit" id="btnSave" class="flex-1 bg-blue-600 text-white py-3.5 rounded-xl font-bold text-base shadow-lg hover:bg-blue-700 transition transform active:scale-95">ì €ì¥</button>
                </div>
                <div class="text-center pt-2">
                    <button type="button" onclick="deleteCurrentItem()" id="btnDelete" class="text-red-400 text-xs py-2 px-4 hidden hover:text-red-600 transition"><i class="fa-solid fa-trash mr-1"></i> ì‚­ì œí•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --------------------------------------------------------------------
        // ğŸ”¥ [í•„ìˆ˜] ë³¸ì¸ì˜ Firebase Configë¡œ êµì²´í•˜ì„¸ìš”!
        // --------------------------------------------------------------------
        const firebaseConfig = {
          apiKey: "AIzaSyDhjSgDBdNu8stWUlqQbCWU2YhZkczlj3o",
          authDomain: "mytrip-2025-2bc36.firebaseapp.com",
          projectId: "mytrip-2025-2bc36",
          storageBucket: "mytrip-2025-2bc36.firebasestorage.app",
          messagingSenderId: "119786186294",
          appId: "1:119786186294:web:724b3881fcc070096c9a97",
          measurementId: "G-LCQD1E1QL7"
        };
        // --------------------------------------------------------------------

        let app, db;
        let isDataLoadedFromServer = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.getElementById('loading').style.display = 'none';
        }

        // Global Functions
        window.switchTab = switchTab;
        window.render = render;
        window.openMapModal = openMapModal;
        window.closeMapModal = closeMapModal;
        window.copyChnName = copyChnName;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.saveItem = saveItem;
        window.deleteCurrentItem = deleteCurrentItem;
        window.handleAddButton = handleAddButton;
        window.toggleEditMode = toggleEditMode;
        window.toggleWishlistPicker = toggleWishlistPicker;
        window.fillFromWishlist = fillFromWishlist;
        window.openSettingsModal = () => document.getElementById('settingsModal').classList.remove('hidden');
        window.closeSettingsModal = () => document.getElementById('settingsModal').classList.add('hidden');
        window.downloadBackup = downloadBackup;
        window.restoreBackup = restoreBackup;
        window.printFullSchedule = printFullSchedule;
        
        window.copyItemName = (text) => {
            if(!text) return alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            navigator.clipboard.writeText(text).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
        };

        // Fallback Data
        const initialData = {
            schedule: [
                { day: 1, date: "12.30 (í™”)", city: "ì²­ë‘", title: "ì¶œêµ­ ë° ì´ë™", items: [{ id: 101, time: "12:00", title: "ì‹œì•ˆ ì…´ì–‘ êµ­ì œê³µí•­", chnName: "è¥¿å®‰å’¸é˜³å›½é™…æœºåœº", lat: 34.447, lng: 108.751, desc: "ë„ì°© í›„ ë°”ë¡œ ì‹œì•ˆë¶ì—­ìœ¼ë¡œ ì´ë™", icon: "fa-plane-arrival" }] },
                { day: 2, date: "12.31 (ìˆ˜)", city: "ì²­ë‘", title: "íŒë‹¤ & ì¹´ìš´íŠ¸ë‹¤ìš´", items: [{ id: 201, time: "08:30", title: "ì²­ë‘ íŒë‹¤ ê¸°ì§€", chnName: "æˆéƒ½å¤§ç†ŠçŒ«ç¹è‚²ç ”ç©¶åŸºåœ°", lat: 30.733, lng: 104.146, desc: "íŒë‹¤ ê´€ëŒ", icon: "fa-paw" }] },
                { day: 3, date: "01.01 (ëª©)", city: "ì²­ë‘", title: "ì—¬ìœ ì™€ íë§", items: [] },
                { day: 4, date: "01.02 (ê¸ˆ)", city: "ì‹œì•ˆ", title: "ì‹œì•ˆ ì´ë™ & ì•¼ê²½", items: [] },
                { day: 5, date: "01.03 (í† )", city: "ì‹œì•ˆ", title: "ë³‘ë§ˆìš© & ì¥í•œê°€", items: [{ id: 501, time: "10:00", title: "ë³‘ë§ˆìš©ê°±", chnName: "ç§¦å§‹çš‡å…µé©¬ä¿‘åšç‰©é¦†", lat: 34.385, lng: 109.278, desc: "ì§„ì‹œí™©ì˜ êµ°ë‹¨", icon: "fa-person-military-pointing", isHighlight: true }] },
                { day: 6, date: "01.04 (ì¼)", city: "ì‹œì•ˆ", title: "ëŒ€ë‹¹ë¶ˆì•¼ì„±", items: [] },
                { day: 7, date: "01.05 (ì›”)", city: "ì‹œì•ˆ", title: "ê·€êµ­", items: [] }
            ],
            wishlist: []
        };

        let scheduleData = initialData.schedule;
        let wishlistData = initialData.wishlist;
        let currentDay = 0;
        let viewMode = 'list';
        let isEditMode = false; 
        let modalTarget = null;

        // --- Firebase Logic ---
        async function initData() {
            if (!db) { render(); return; }
            const docRef = doc(db, "trips", "shared_schedule");
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    scheduleData = data.data || initialData.schedule;
                    wishlistData = data.wishlist || [];
                    isDataLoadedFromServer = true; 
                    updateStatus(true);
                    localStorage.setItem('trip_backup', JSON.stringify({data: scheduleData, wishlist: wishlistData}));
                } else {
                    if (!isDataLoadedFromServer) {
                        scheduleData = initialData.schedule;
                        wishlistData = [];
                        isDataLoadedFromServer = true;
                    }
                }
                render();
                document.getElementById('loading').style.display = 'none';
            }, (error) => {
                console.error("Sync Error:", error);
                updateStatus(false);
                const backup = localStorage.getItem('trip_backup');
                if (backup) {
                    const parsed = JSON.parse(backup);
                    scheduleData = parsed.data;
                    wishlistData = parsed.wishlist;
                    render();
                }
                document.getElementById('loading').style.display = 'none';
            });
        }

        function updateStatus(isOnline) {
            const badge = document.getElementById('liveBadge');
            const sync = document.getElementById('syncStatus');
            const saveBtn = document.getElementById('btnSave');
            if (isOnline) {
                badge.innerText = "LIVE";
                badge.className = "text-[10px] text-blue-500 bg-blue-50 px-1.5 py-0.5 rounded align-top animate-pulse font-bold";
                sync.innerHTML = `<i class="fa-solid fa-cloud text-green-500"></i> <span class="text-green-500 font-bold">ë™ê¸°í™” ì™„ë£Œ</span>`;
                if(saveBtn) saveBtn.disabled = false;
            } else {
                badge.innerText = "OFFLINE";
                badge.className = "text-[10px] text-red-500 bg-red-50 px-1.5 py-0.5 rounded align-top font-bold";
                sync.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i> <span class="text-red-500 font-bold">ì—°ê²° ëŠê¹€</span>`;
                if(saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerText = "ì„œë²„ ì—°ê²° ëŒ€ê¸°ì¤‘...";
                    saveBtn.classList.add('bg-gray-400');
                }
            }
        }

        async function saveData() {
            if (!db) { alert("ì„œë²„ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
            document.getElementById('syncStatus').innerHTML = `<i class="fa-solid fa-cloud-arrow-up text-orange-500"></i> <span class="text-orange-500">ì €ì¥ ì¤‘...</span>`;
            try {
                await setDoc(doc(db, "trips", "shared_schedule"), { data: scheduleData, wishlist: wishlistData });
            } catch(e) { 
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
                updateStatus(false);
            }
        }

        // --- UI & Render Logic ---
        function switchTab(mode) {
            viewMode = mode;
            document.getElementById('dateNavWrapper').classList.toggle('hidden', mode !== 'list');
            const t1 = document.getElementById('tabList');
            const t2 = document.getElementById('tabWishlist');
            t1.className = mode === 'list' ? "flex-1 py-3.5 text-sm md:text-base text-center transition active-tab" : "flex-1 py-3.5 text-sm md:text-base text-center transition inactive-tab hover:bg-gray-50";
            t2.className = mode === 'wishlist' ? "flex-1 py-3.5 text-sm md:text-base text-center transition active-tab" : "flex-1 py-3.5 text-sm md:text-base text-center transition inactive-tab hover:bg-gray-50";
            render();
        }

        function render() {
            document.getElementById('wishlistCount').innerText = wishlistData.length;
            const container = document.getElementById('schedule-container');
            const fab = document.getElementById('fabAdd');
            
            if (viewMode === 'list') { renderNav(); renderSchedule(container); }
            else { renderWishlist(container); }

            if (viewMode === 'wishlist' || (viewMode === 'list' && isEditMode)) fab.classList.remove('hidden');
            else fab.classList.add('hidden');
        }

        function renderNav() {
            const container = document.getElementById('dateNav');
            container.innerHTML = '';
            scheduleData.forEach((dayData, idx) => {
                const btn = document.createElement('button');
                const isActive = idx === currentDay;
                btn.className = `flex-none py-2 px-4 rounded-full text-center transition-all duration-200 border ${isActive ? 'bg-gray-900 text-white border-gray-900 shadow-md transform scale-105' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`;
                btn.onclick = () => { currentDay = idx; render(); };
                btn.innerHTML = `<div class="text-[10px] opacity-80 mb-0.5">${dayData.city}</div><div class="text-sm font-bold">${dayData.date.split(' ')[0]}</div>`;
                container.appendChild(btn);
                if (isActive) setTimeout(() => btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }), 100);
            });
        }

        function renderSchedule(container) {
            const data = scheduleData[currentDay];
            let html = `<div class="animate-fade-in pb-16">
                <div class="mb-8 text-center md:text-left p-4 bg-white rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="text-2xl font-extrabold text-gray-900">${data.title}</h2>
                    <p class="text-sm text-gray-500 mt-1 font-medium">${data.date} Â· ${data.city} Â· ${data.items.length}ê°œì˜ ì¼ì •</p>
                </div>
                
                <div class="timeline-container max-w-4xl mx-auto">
                    <div class="timeline-line"></div>
                    <div class="flex flex-col gap-6">`;

            if (data.items.length === 0) html += `<div class="text-center py-12 text-gray-400 bg-white rounded-2xl border border-dashed border-gray-200"><i class="fa-regular fa-calendar-xmark text-3xl mb-3"></i><p>ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.<br>+ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p></div>`;
            
            data.items.forEach((item, index) => html += createCardHtml(item, index + 1, 'schedule'));
            html += `</div></div></div>`;
            container.innerHTML = html;
        }

        function renderWishlist(container) {
            if (wishlistData.length === 0) { container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 animate-fade-in"><i class="fa-regular fa-heart text-4xl mb-3"></i><p class="mt-4 font-medium">ë³´ê´€í•¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p><p class="text-xs text-gray-400 mt-1">ê°€ê³  ì‹¶ì€ ê³³ì„ ë¯¸ë¦¬ ì €ì¥í•´ë³´ì„¸ìš”!</p></div>`; return; }
            let html = `<div class="mt-4 animate-fade-in grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">`;
            wishlistData.forEach(item => html += createCardHtml(item, null, 'wishlist'));
            html += `</div>`;
            container.innerHTML = html;
        }

        function createCardHtml(item, index, type) {
            let actionButtons = '';
            let btnStyle = "w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 hover:text-blue-600 transition";
            
            if (type === 'schedule') {
                actionButtons = `<div class="absolute top-4 right-4 z-20"><button onclick="openEditModal(${item.id}, 'schedule')" class="${btnStyle}"><i class="fa-solid fa-pen text-xs"></i></button></div>`;
            } else if (type === 'wishlist') {
                actionButtons = `<div class="absolute top-4 right-4 z-20"><button onclick="openEditModal(${item.id}, 'wishlist')" class="${btnStyle}"><i class="fa-solid fa-pen text-xs"></i></button></div>`;
            }
            
            if (type === 'schedule') {
                // ì‹±ê¸€ ì»¬ëŸ¼ íƒ€ì„ë¼ì¸
                return `
                <div class="relative flex gap-4 z-10 items-start group animate-fade-in">
                    <!-- íƒ€ì„ë¼ì¸ ìˆ«ì (ì™¼ìª½ ê³ ì •) -->
                    <div class="flex-shrink-0 w-16 flex flex-col items-center z-20">
                        <div class="w-8 h-8 rounded-full ${item.isHighlight ? 'bg-red-500 text-white' : 'bg-white border-2 border-gray-200 text-gray-500'} shadow-sm flex items-center justify-center text-sm font-bold z-10 mb-1 transition-transform group-hover:scale-110">${index}</div>
                        <!-- ì‹œê°„ í‘œì‹œ -->
                        <span class="text-xs font-mono font-bold text-gray-400 bg-white px-1">${item.time}</span>
                    </div>
                    
                    <!-- ì¹´ë“œ (ì˜¤ë¥¸ìª½ìœ¼ë¡œ í™•ì¥) -->
                    <div class="flex-1 schedule-card bg-white rounded-2xl p-5 shadow-sm border border-gray-100 relative overflow-hidden">
                        ${actionButtons}
                        <div class="flex justify-between items-start mb-1 pr-8">
                            <h3 class="font-bold text-gray-800 text-lg leading-tight">${item.title}</h3>
                        </div>
                        <p class="text-xs text-gray-500 font-medium mb-2">${item.chnName || ''}</p>
                        <p class="text-sm text-gray-600 leading-relaxed mb-4 line-clamp-3">${item.desc || ''}</p>
                        <div class="flex gap-2 mt-3 border-t border-gray-50 pt-3">
                            <button onclick="openMapModal(${item.id})" class="flex-1 md:flex-none flex items-center justify-center gap-2 bg-blue-50 text-blue-600 py-2 px-4 rounded-lg text-sm font-medium hover:bg-blue-100 transition"><i class="fa-solid fa-map-location-dot"></i> ì§€ë„</button>
                        </div>
                    </div>
                </div>`;
            } else {
                // Wishlist Card
                return `
                <div class="schedule-card relative flex flex-col bg-white rounded-2xl p-5 shadow-sm border border-gray-100 h-full group">
                    ${actionButtons}
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center text-lg shadow-sm flex-shrink-0"><i class="fa-solid ${item.icon}"></i></div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-gray-800 text-lg leading-tight truncate pr-6">${item.title}</h3>
                            <p class="text-xs text-gray-500 font-medium truncate">${item.chnName || 'ì¤‘êµ­ì–´ ëª…ì¹­ ì—†ìŒ'}</p>
                        </div>
                    </div>
                    <div class="flex-grow bg-gray-50 rounded-xl p-3 mb-4 border border-gray-100">
                        <p class="text-sm text-gray-600 leading-relaxed line-clamp-3">${item.desc || 'ì„¤ëª… ì—†ìŒ'}</p>
                    </div>
                    <!-- ğŸ”¥ [ì§€ëª… ë³µì‚¬] | [ì§€ë„] ë²„íŠ¼ ë¶„ë¦¬ -->
                    <div class="flex gap-2 mt-auto pt-3 border-t border-gray-50">
                        <button onclick="copyItemName('${item.chnName || item.title}')" class="flex-1 bg-white text-gray-600 py-2.5 rounded-xl text-xs font-bold hover:bg-gray-50 hover:text-blue-600 transition border border-gray-200 flex items-center justify-center gap-1.5">
                            <i class="fa-regular fa-copy"></i> ì§€ëª… ë³µì‚¬
                        </button>
                        <button onclick="openMapModal(${item.id})" class="flex-1 bg-white text-gray-600 py-2.5 rounded-xl text-xs font-bold hover:bg-gray-50 hover:text-blue-600 transition border border-gray-200 flex items-center justify-center gap-1.5">
                            <i class="fa-solid fa-map-location-dot"></i> ì§€ë„
                        </button>
                    </div>
                </div>`;
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            render();
        }

        function handleAddButton() { openEditModal(null, viewMode === 'wishlist' ? 'wishlist' : 'schedule'); }
        
        function openEditModal(itemId, mode) {
            const form = document.getElementById('editForm');
            form.reset();
            document.getElementById('editItemMode').value = mode;
            document.getElementById('wishlistPicker').classList.add('hidden');
            
            const isWishlist = mode === 'wishlist';
            document.getElementById('editModalTitle').innerText = isWishlist ? "ë³´ê´€í•¨ ì¶”ê°€" : "ì¼ì • ì¶”ê°€";
            document.getElementById('wishlistImportSection').classList.toggle('hidden', isWishlist || itemId);
            document.getElementById('timeInputGroup').classList.toggle('hidden', isWishlist);
            document.getElementById('iconOnlyGroup').classList.toggle('hidden', !isWishlist);
            document.getElementById('btnDelete').classList.toggle('hidden', !itemId);

            if (itemId) {
                const item = isWishlist ? wishlistData.find(i => i.id === itemId) : scheduleData[currentDay].items.find(i => i.id === itemId);
                if (item) {
                    document.getElementById('editModalTitle').innerText = "ë‚´ìš© ìˆ˜ì •";
                    document.getElementById('editItemId').value = item.id;
                    document.getElementById('editTime').value = item.time || "10:00";
                    document.getElementById('editIcon').value = item.icon;
                    document.getElementById('editIconOnly').value = item.icon;
                    document.getElementById('editTitle').value = item.title;
                    document.getElementById('editChnName').value = item.chnName || '';
                    document.getElementById('editDesc').value = item.desc || '';
                    document.getElementById('editMapUrl').value = item.mapUrl || '';
                    document.getElementById('editLat').value = item.lat || '';
                    document.getElementById('editLng').value = item.lng || '';
                }
            } else {
                document.getElementById('editItemId').value = '';
                document.getElementById('editTime').value = "10:00";
            }
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        function toggleWishlistPicker() {
            const picker = document.getElementById('wishlistPicker');
            if (picker.classList.contains('hidden')) {
                picker.innerHTML = wishlistData.length ? '' : '<div class="text-center text-gray-400 text-xs py-2">ë³´ê´€í•¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>';
                wishlistData.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-3 hover:bg-blue-50 rounded-xl cursor-pointer border-b border-gray-50 transition";
                    div.onclick = () => fillFromWishlist(item);
                    div.innerHTML = `<div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid ${item.icon}"></i></div><div><div class="font-bold text-sm text-gray-800">${item.title}</div></div>`;
                    picker.appendChild(div);
                });
                picker.classList.remove('hidden');
            } else picker.classList.add('hidden');
        }

        function fillFromWishlist(item) {
            document.getElementById('editTitle').value = item.title;
            document.getElementById('editChnName').value = item.chnName || '';
            document.getElementById('editDesc').value = item.desc || '';
            document.getElementById('editIcon').value = item.icon;
            document.getElementById('editMapUrl').value = item.mapUrl || '';
            document.getElementById('editLat').value = item.lat || '';
            document.getElementById('editLng').value = item.lng || '';
            document.getElementById('wishlistPicker').classList.add('hidden');
        }

        function saveItem(e) {
            e.preventDefault();
            if (!isDataLoadedFromServer) { alert("ì„œë²„ ì—°ê²° ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤."); return; }
            const idVal = document.getElementById('editItemId').value;
            const mode = document.getElementById('editItemMode').value;
            const itemData = {
                time: document.getElementById('editTime').value,
                icon: document.getElementById('editIcon').value,
                title: document.getElementById('editTitle').value,
                chnName: document.getElementById('editChnName').value,
                desc: document.getElementById('editDesc').value,
                mapUrl: document.getElementById('editMapUrl').value,
                lat: parseFloat(document.getElementById('editLat').value) || 0,
                lng: parseFloat(document.getElementById('editLng').value) || 0
            };
            const id = idVal ? parseInt(idVal) : Date.now();

            if (mode === 'wishlist') {
                const idx = wishlistData.findIndex(i => i.id === id);
                if (idx > -1) wishlistData[idx] = { ...wishlistData[idx], ...itemData, id };
                else wishlistData.push({ id, ...itemData });
            } else {
                const items = scheduleData[currentDay].items;
                const idx = items.findIndex(i => i.id === id);
                if (idx > -1) items[idx] = { ...items[idx], ...itemData, id };
                else items.push({ id, ...itemData, isHighlight: false });
                scheduleData[currentDay].items.sort((a, b) => a.time.localeCompare(b.time));
            }
            saveData().then(() => closeEditModal());
        }

        function deleteCurrentItem() {
            if (!isDataLoadedFromServer) return;
            const id = parseInt(document.getElementById('editItemId').value);
            const mode = document.getElementById('editItemMode').value;
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (mode === 'wishlist') wishlistData = wishlistData.filter(i => i.id !== id);
                else scheduleData[currentDay].items = scheduleData[currentDay].items.filter(i => i.id !== id);
                saveData().then(() => closeEditModal());
            }
        }

        function openMapModal(itemId) {
            let item = null;
            if (scheduleData[currentDay]) item = scheduleData[currentDay].items.find(i => i.id === itemId);
            if (!item) for(let d of scheduleData) { item = d.items.find(i => i.id === itemId); if(item) break; }
            if (!item) item = wishlistData.find(i => i.id === itemId);
            if(!item) return;
            modalTarget = item;
            document.getElementById('modalTitle').innerText = item.title;
            document.getElementById('modalChnName').innerText = item.chnName || 'ì—†ìŒ';
            const container = document.getElementById('mapActions');
            container.innerHTML = ''; 
            if(item.mapUrl) container.innerHTML += `<a href="${item.mapUrl}" target="_blank" class="flex items-center justify-between p-4 rounded-xl bg-gray-100 border border-gray-200 hover:bg-gray-100 transition mb-2"><span class="font-bold text-sm text-gray-700">ğŸ”— ì§€ë„ ë§í¬ ì—´ê¸°</span><i class="fa-solid fa-arrow-up-right-from-square text-gray-400"></i></a>`;
            if(item.lat && item.lng) {
                const gaodeLink = `https://uri.amap.com/marker?position=${item.lng},${item.lat}&name=${encodeURIComponent(item.chnName||item.title)}`;
                container.innerHTML += `<a href="${gaodeLink}" target="_blank" class="flex items-center justify-center gap-2 p-4 rounded-xl bg-blue-50 text-blue-700 border border-blue-100 hover:bg-blue-100 transition"><span class="font-bold text-sm">ğŸ“ ê³ ë•ì§€ë„ ì¢Œí‘œ</span></a>`;
            }
            const query = item.chnName || item.title;
            container.innerHTML += `<div class="mt-4 border-t border-gray-100 pt-4 grid grid-cols-2 gap-3"><a href="https://uri.amap.com/search?keyword=${encodeURIComponent(query)}" target="_blank" class="p-3.5 rounded-xl bg-white border border-gray-200 text-center text-sm font-bold text-blue-600 hover:bg-blue-50 transition">ê³ ë• ê²€ìƒ‰</a><a href="http://api.map.baidu.com/geocoder?address=${encodeURIComponent(query)}&output=html" target="_blank" class="p-3.5 rounded-xl bg-white border border-gray-200 text-center text-sm font-bold text-red-600 hover:bg-red-50 transition">ë°”ì´ë‘ ê²€ìƒ‰</a></div>`;
            document.getElementById('mapModal').classList.remove('hidden');
        }
        function closeMapModal() { document.getElementById('mapModal').classList.add('hidden'); }
        function copyChnName() { if(modalTarget && modalTarget.chnName) navigator.clipboard.writeText(modalTarget.chnName).then(() => alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!')); }
        document.getElementById('mapModal').addEventListener('click', (e) => { if (e.target.id === 'mapModal') closeMapModal(); });

        window.openSettingsModal = () => document.getElementById('settingsModal').classList.remove('hidden');
        window.closeSettingsModal = () => document.getElementById('settingsModal').classList.add('hidden');
        window.toggleEditMode = () => render(); 
        function downloadBackup() {
            const blob = new Blob([JSON.stringify({ schedule: scheduleData, wishlist: wishlistData }, null, 2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `trip_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function restoreBackup(input) {
            if (!input.files[0] || !confirm("ë°ì´í„°ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const d = JSON.parse(e.target.result);
                    scheduleData = d.schedule; wishlistData = d.wishlist;
                    await saveData(); 
                    alert("ë³µì› ì™„ë£Œ"); render();
                } catch(err) { alert("ì˜¤ë¥˜"); }
            };
            reader.readAsText(input.files[0]);
        }
        function printFullSchedule() {
            const printArea = document.getElementById('print-area');
            let html = `<h1 style="text-align:center; font-size:24px; margin-bottom:30px; font-family:sans-serif;">ì²­ë‘ & ì‹œì•ˆ 6ë°• 7ì¼</h1>`;
            scheduleData.forEach(day => {
                html += `<div class="print-day-header">Day ${day.day} <span style="font-weight:normal; font-size:14px; margin-left:10px;">${day.date}</span></div>`;
                if (day.items.length === 0) html += `<div style="padding:10px; color:#999; font-size:12px;">ì¼ì • ì—†ìŒ</div>`;
                else day.items.forEach(item => { html += `<div class="print-item"><div class="print-time">${item.time}</div><div style="flex:1;"><div><span class="print-title">${item.title}</span> <span style="font-size:12px; color:#666;">${item.chnName||''}</span></div><div class="print-desc">${item.desc||''}</div></div></div>`; });
            });
            if (wishlistData.length > 0) {
                html += `<div class="print-day-header" style="margin-top:40px; border-color:#999;">ğŸ’– ë³´ê´€í•¨</div>`;
                wishlistData.forEach(item => { html += `<div class="print-item"><div class="print-time">â™¥</div><div style="flex:1;"><div class="print-title">${item.title}</div><div class="print-desc">${item.desc||''}</div></div></div>`; });
            }
            printArea.innerHTML = html;
            window.print();
        }

        initData();
    </script>
</body>
</html>
