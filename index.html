<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>ì²­ë‘ & ì‹œì•ˆ ì—¬í–‰ (Backup)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; padding-bottom: 100px; padding-top: env(safe-area-inset-top); user-select: none; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .timeline-line { position: absolute; left: 28px; top: 20px; bottom: 0; width: 2px; bg-gray-200; z-index: 0; background-color: #e5e7eb; }
        .active-tab { border-bottom: 2px solid #ef4444; color: #ef4444; font-weight: 700; }
        .inactive-tab { color: #9ca3af; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* ğŸ–¨ï¸ ì¸ì‡„ ì „ìš© ìŠ¤íƒ€ì¼ (í•µì‹¬ ìˆ˜ì •) */
        @media print {
            /* ê¸°ì¡´ í™”ë©´ì˜ ëª¨ë“  ìš”ì†Œ ìˆ¨ê¹€ */
            body > * { display: none !important; }
            
            /* ì¸ì‡„ ì˜ì—­ë§Œ í‘œì‹œ */
            #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 20px; }
            #print-area * { visibility: visible; }
            
            /* ì¸ì‡„ ì‹œ ìŠ¤íƒ€ì¼ ì¬ì •ì˜ (ì‰í¬ ì ˆì•½ ë° ê°€ë…ì„±) */
            .print-day-header { break-inside: avoid; page-break-after: avoid; border-bottom: 2px solid #333; margin-top: 30px; padding-bottom: 5px; margin-bottom: 15px; }
            .print-item { break-inside: avoid; page-break-inside: avoid; display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            .print-time { font-weight: bold; width: 60px; flex-shrink: 0; }
            .print-content { flex-grow: 1; }
            .print-title { font-weight: bold; font-size: 16px; }
            .print-chn { font-size: 12px; color: #666; margin-top: 2px; }
            .print-desc { font-size: 12px; color: #444; margin-top: 4px; white-space: pre-line; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 max-w-md mx-auto shadow-2xl min-h-screen relative">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-4 py-3 flex justify-between items-center bg-white border-b border-gray-100">
            <div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight">ì²­ë‘ & ì‹œì•ˆ ì—¬í–‰ <span id="liveBadge" class="text-[10px] text-gray-400 bg-gray-100 px-1 rounded align-top">OFFLINE</span></h1>
                <p class="text-xs text-gray-500 flex items-center gap-1">
                    <span id="totalDays">6ë°• 7ì¼</span>
                    <span id="syncStatus" class="text-gray-300 text-[10px] ml-2"><i class="fa-solid fa-circle-notch fa-spin"></i> ì—°ê²° ì¤‘...</span>
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="openSettingsModal()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center transition hover:bg-gray-200">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
        
        <div class="flex border-b border-gray-200 bg-white">
            <button onclick="switchTab('list')" class="flex-1 py-3 text-sm font-medium text-center text-red-500 border-b-2 border-red-500 transition" id="tabList">ğŸ“… ì¼ì •í‘œ</button>
            <button onclick="switchTab('wishlist')" class="flex-1 py-3 text-sm font-medium text-center text-gray-400 hover:text-gray-600 transition" id="tabWishlist">ğŸ’– ë³´ê´€í•¨ (<span id="wishlistCount">0</span>)</button>
        </div>

        <div id="dateNavWrapper" class="overflow-x-auto hide-scrollbar bg-white shadow-sm transition-all duration-300">
            <div class="flex px-2 min-w-max" id="dateNav"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="schedule-container" class="p-4 min-h-[60vh] pb-32"></main>

    <!-- ğŸ–¨ï¸ ì¸ì‡„ ì „ìš© ìˆ¨ê²¨ì§„ ì˜ì—­ (ì—¬ê¸°ì— ì „ì²´ ì¼ì •ì´ ê·¸ë ¤ì§) -->
    <div id="print-area" class="hidden"></div>

    <!-- FAB -->
    <div id="fabAdd" class="fixed bottom-24 right-6 z-30 hidden">
        <button onclick="handleAddButton()" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition transform active:scale-90"><i class="fa-solid fa-plus text-2xl"></i></button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 font-medium">ë°ì´í„° ì•ˆì „í•˜ê²Œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- Modals -->
    <!-- 1. Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center px-6 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 animate-fade-in shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-900">ì„¤ì • ë° ë°±ì—…</h3>
                <button onclick="closeSettingsModal()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="space-y-3">
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                    <h4 class="text-sm font-bold text-blue-800 mb-1">ğŸ’¾ ë°ì´í„° ë°±ì—…</h4>
                    <p class="text-xs text-blue-600 mb-3">í˜„ì¬ ì¼ì •ì„ íŒŒì¼ë¡œ ì €ì¥í•´ë‘¡ë‹ˆë‹¤.</p>
                    <button onclick="downloadBackup()" class="w-full bg-white border border-blue-200 text-blue-600 py-2 rounded-lg text-sm font-bold hover:bg-blue-50">
                        <i class="fa-solid fa-download mr-2"></i>ë‚´ ì»´í“¨í„°ì— ì €ì¥í•˜ê¸°
                    </button>
                </div>

                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <h4 class="text-sm font-bold text-gray-800 mb-1">â™»ï¸ ë°ì´í„° ë³µì›</h4>
                    <p class="text-xs text-gray-500 mb-3">ì €ì¥í•´ë‘” íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
                    <label class="w-full block bg-white border border-gray-300 text-gray-600 py-2 rounded-lg text-sm font-bold text-center hover:bg-gray-100 cursor-pointer">
                        <i class="fa-solid fa-upload mr-2"></i>íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
                        <input type="file" id="backupFile" accept=".json" class="hidden" onchange="restoreBackup(this)">
                    </label>
                </div>

                <!-- ğŸ”¥ ì¸ì‡„ ë²„íŠ¼ ìˆ˜ì •ë¨: printFullSchedule() í˜¸ì¶œ -->
                <button onclick="printFullSchedule()" class="w-full py-3 text-gray-800 font-bold text-sm bg-gray-100 rounded-lg hover:bg-gray-200 border border-gray-200">
                    <i class="fa-solid fa-print mr-2"></i> ì „ì²´ ì¼ì • ì¸ì‡„í•˜ê¸° (PDF)
                </button>
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-100 text-center">
                <p class="text-[10px] text-gray-400">App Version 2.2 (Print Fix)</p>
            </div>
        </div>
    </div>

    <!-- 2. Map Modal -->
    <div id="mapModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center px-6 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 animate-fade-in shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <div><h3 class="text-lg font-bold text-gray-900" id="modalTitle">ì¥ì†Œ</h3><p class="text-sm text-gray-500" id="modalChnName">ì¤‘êµ­ì–´</p></div>
                <button onclick="closeMapModal()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="mapActions" class="space-y-3"></div>
            <button onclick="copyChnName()" class="w-full mt-4 py-3 text-sm text-gray-600 bg-gray-50 border border-gray-200 rounded-xl font-medium hover:bg-gray-100 transition"><i class="fa-regular fa-copy mr-1"></i> ì¤‘êµ­ì–´ ì§€ëª… ë³µì‚¬</button>
        </div>
    </div>

    <!-- 3. Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center sm:px-4">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-slide-up sm:animate-fade-in h-[90vh] sm:h-auto overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="editModalTitle">ì¶”ê°€</h3>
                <button onclick="closeEditModal()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div id="wishlistImportSection" class="mb-6 hidden">
                <button onclick="toggleWishlistPicker()" class="w-full flex items-center justify-between bg-red-50 text-red-600 p-3 rounded-xl border border-red-100 hover:bg-red-100 transition"><span class="font-bold text-sm"><i class="fa-solid fa-heart mr-2"></i>ë³´ê´€í•¨ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</span><i class="fa-solid fa-chevron-down"></i></button>
                <div id="wishlistPicker" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-sm max-h-48 overflow-y-auto p-2 space-y-2"></div>
            </div>
            <form id="editForm" onsubmit="saveItem(event)" class="space-y-4">
                <input type="hidden" id="editItemId"><input type="hidden" id="editItemMode">
                <div class="grid grid-cols-3 gap-3" id="timeInputGroup">
                    <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">ì‹œê°„</label><input type="text" id="editTime" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-center"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500 mb-1">ì•„ì´ì½˜</label><select id="editIcon" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3"><option value="fa-location-dot">ğŸ“ ì¥ì†Œ</option><option value="fa-utensils">ğŸ´ ì‹ì‚¬</option><option value="fa-hotel">ğŸ¨ ìˆ™ì†Œ</option><option value="fa-plane">âœˆï¸ ê³µí•­</option><option value="fa-train">ğŸš„ ê¸°ì°¨</option><option value="fa-camera">ğŸ“· ê´€ê´‘</option><option value="fa-bag-shopping">ğŸ›ï¸ ì‡¼í•‘</option><option value="fa-coffee">â˜• ì¹´í˜</option></select></div>
                </div>
                <div id="iconOnlyGroup" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-1">ì•„ì´ì½˜</label><select id="editIconOnly" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3" onchange="document.getElementById('editIcon').value = this.value"><option value="fa-location-dot">ğŸ“ ì¥ì†Œ</option><option value="fa-utensils">ğŸ´ ì‹ì‚¬</option><option value="fa-hotel">ğŸ¨ ìˆ™ì†Œ</option><option value="fa-plane">âœˆï¸ ê³µí•­</option><option value="fa-train">ğŸš„ ê¸°ì°¨</option><option value="fa-camera">ğŸ“· ê´€ê´‘</option><option value="fa-bag-shopping">ğŸ›ï¸ ì‡¼í•‘</option><option value="fa-coffee">â˜• ì¹´í˜</option></select></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì¥ì†Œëª… (í•œê¸€)</label><input type="text" id="editTitle" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 font-medium" required></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì¥ì†Œëª… (ì¤‘êµ­ì–´)</label><input type="text" id="editChnName" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì„¤ëª…</label><textarea id="editDesc" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3"></textarea></div>
                <div class="border border-gray-100 rounded-xl p-3 bg-gray-50">
                    <p class="text-xs font-bold text-gray-500 mb-2">ğŸ—ºï¸ ì§€ë„ ì„¤ì •</p>
                    <div class="mb-3"><input type="url" id="editMapUrl" placeholder="ì§€ë„ ë§í¬ (URL)" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm"></div>
                    <details class="text-xs text-gray-500"><summary class="cursor-pointer">ì¢Œí‘œ ì…ë ¥</summary><div class="grid grid-cols-2 gap-2 mt-2"><input type="number" step="any" id="editLat" placeholder="ìœ„ë„" class="bg-white border p-2"><input type="number" step="any" id="editLng" placeholder="ê²½ë„" class="bg-white border p-2"></div></details>
                </div>
                <div class="flex gap-3 pt-2"><button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-100 text-gray-600 py-3.5 rounded-xl font-bold">ì·¨ì†Œ</button><button type="submit" id="btnSave" class="flex-1 bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg">ì €ì¥</button></div>
                <div class="text-center pt-2"><button type="button" onclick="deleteCurrentItem()" id="btnDelete" class="text-red-400 text-xs py-2 px-4 hidden"><i class="fa-solid fa-trash mr-1"></i> ì‚­ì œ</button></div>
            </form>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 z-20"><button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="bg-white text-gray-800 w-10 h-10 rounded-full shadow border border-gray-200 flex items-center justify-center"><i class="fa-solid fa-arrow-up"></i></button></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDhjSgDBdNu8stWUlqQbCWU2YhZkczlj3o",
          authDomain: "mytrip-2025-2bc36.firebaseapp.com",
          projectId: "mytrip-2025-2bc36",
          storageBucket: "mytrip-2025-2bc36.firebasestorage.app",
          messagingSenderId: "119786186294",
          appId: "1:119786186294:web:724b3881fcc070096c9a97",
          measurementId: "G-LCQD1E1QL7"
        };

        let app, db;
        let isDataLoadedFromServer = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.getElementById('loading').style.display = 'none';
        }

        // Global Functions
        window.switchTab = switchTab;
        window.render = render;
        window.openMapModal = openMapModal;
        window.closeMapModal = closeMapModal;
        window.copyChnName = copyChnName;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.saveItem = saveItem;
        window.deleteCurrentItem = deleteCurrentItem;
        window.handleAddButton = handleAddButton;
        window.toggleWishlistPicker = toggleWishlistPicker;
        window.fillFromWishlist = fillFromWishlist;
        window.openSettingsModal = () => document.getElementById('settingsModal').classList.remove('hidden');
        window.closeSettingsModal = () => document.getElementById('settingsModal').classList.add('hidden');
        window.downloadBackup = downloadBackup;
        window.restoreBackup = restoreBackup;
        
        // ğŸ”¥ New Print Function
        window.printFullSchedule = printFullSchedule;

        // Fallback Data
        const initialData = {
            schedule: [
                { day: 1, date: "12.30 (í™”)", city: "ì²­ë‘", title: "ì¶œêµ­ ë° ì´ë™", items: [{ id: 101, time: "12:00", title: "ì‹œì•ˆ ì…´ì–‘ êµ­ì œê³µí•­", chnName: "è¥¿å®‰å’¸é˜³å›½é™…æœºåœº", lat: 34.447, lng: 108.751, desc: "ë„ì°© í›„ ë°”ë¡œ ì‹œì•ˆë¶ì—­ìœ¼ë¡œ ì´ë™", icon: "fa-plane-arrival" }] },
                { day: 2, date: "12.31 (ìˆ˜)", city: "ì²­ë‘", title: "íŒë‹¤ & ì¹´ìš´íŠ¸ë‹¤ìš´", items: [{ id: 201, time: "08:30", title: "ì²­ë‘ íŒë‹¤ ê¸°ì§€", chnName: "æˆéƒ½å¤§ç†ŠçŒ«ç¹è‚²ç ”ç©¶åŸºåœ°", lat: 30.733, lng: 104.146, desc: "íŒë‹¤ ê´€ëŒ", icon: "fa-paw" }] },
                { day: 3, date: "01.01 (ëª©)", city: "ì²­ë‘", title: "ì—¬ìœ ì™€ íë§", items: [] },
                { day: 4, date: "01.02 (ê¸ˆ)", city: "ì‹œì•ˆ", title: "ì‹œì•ˆ ì´ë™ & ì•¼ê²½", items: [] },
                { day: 5, date: "01.03 (í† )", city: "ì‹œì•ˆ", title: "ë³‘ë§ˆìš© & ì¥í•œê°€", items: [{ id: 501, time: "10:00", title: "ë³‘ë§ˆìš©ê°±", chnName: "ç§¦å§‹çš‡å…µé©¬ä¿‘åšç‰©é¦†", lat: 34.385, lng: 109.278, desc: "ì§„ì‹œí™©ì˜ êµ°ë‹¨", icon: "fa-person-military-pointing", isHighlight: true }] },
                { day: 6, date: "01.04 (ì¼)", city: "ì‹œì•ˆ", title: "ëŒ€ë‹¹ë¶ˆì•¼ì„±", items: [] },
                { day: 7, date: "01.05 (ì›”)", city: "ì‹œì•ˆ", title: "ê·€êµ­", items: [] }
            ],
            wishlist: []
        };

        let scheduleData = initialData.schedule;
        let wishlistData = initialData.wishlist;
        let currentDay = 0;
        let viewMode = 'list';
        let isEditMode = false; 
        let modalTarget = null;

        // --- Print Logic (NEW) ---
        function printFullSchedule() {
            const printArea = document.getElementById('print-area');
            let html = `<h1 style="text-align:center; font-size:24px; margin-bottom:30px;">ì²­ë‘ & ì‹œì•ˆ 6ë°• 7ì¼ ì—¬í–‰ ì¼ì •í‘œ</h1>`;
            
            scheduleData.forEach(day => {
                html += `
                    <div class="print-day-header">
                        <span style="font-size:20px; font-weight:bold;">Day ${day.day}</span> 
                        <span style="font-size:16px; color:#555; margin-left:10px;">${day.date} (${day.city})</span>
                        <div style="font-size:14px; color:#777; margin-top:4px;">${day.title}</div>
                    </div>
                `;
                
                if (day.items.length === 0) {
                    html += `<div style="padding:10px; color:#999; font-style:italic; font-size:12px;">ì¼ì • ì—†ìŒ</div>`;
                } else {
                    day.items.forEach(item => {
                        html += `
                            <div class="print-item">
                                <div class="print-time">${item.time}</div>
                                <div class="print-content">
                                    <div class="print-title">${item.title}</div>
                                    ${item.chnName ? `<div class="print-chn">${item.chnName}</div>` : ''}
                                    ${item.desc ? `<div class="print-desc">${item.desc}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
            });
            
            // ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì¶”ê°€ (ì„ íƒì‚¬í•­)
            if (wishlistData.length > 0) {
                html += `<div class="print-day-header" style="margin-top:50px; border-color:#ccc;">ğŸ’– ê°€ê³  ì‹¶ì€ ê³³ (ë³´ê´€í•¨)</div>`;
                wishlistData.forEach(item => {
                    html += `
                        <div class="print-item">
                            <div class="print-time" style="font-size:20px; color:#e53e3e;">â™¥</div>
                            <div class="print-content">
                                <div class="print-title">${item.title}</div>
                                ${item.chnName ? `<div class="print-chn">${item.chnName}</div>` : ''}
                                ${item.desc ? `<div class="print-desc">${item.desc}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            printArea.innerHTML = html;
            window.print();
        }

        // --- Backup & Restore Logic ---
        function downloadBackup() {
            if (!scheduleData || scheduleData.length === 0) { alert("ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
            const backupData = { schedule: scheduleData, wishlist: wishlistData, timestamp: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trip_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function restoreBackup(input) {
            if (!input.files || !input.files[0]) return;
            if (!isDataLoadedFromServer) { alert("ì„œë²„ì™€ ì—°ê²°ëœ ìƒíƒœì—ì„œë§Œ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); input.value = ''; return; }
            if (!confirm("âš ï¸ ì£¼ì˜!\n\ní˜„ì¬ ì•±ì— ìˆëŠ” ëª¨ë“  ì¼ì •ì´ ì‚­ì œë˜ê³ ,\nì„ íƒí•œ ë°±ì—… íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.\n\nì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { input.value = ''; return; }
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const restored = JSON.parse(e.target.result);
                    if (restored.schedule && Array.isArray(restored.schedule)) {
                        scheduleData = restored.schedule;
                        wishlistData = restored.wishlist || [];
                        await saveData(); 
                        alert("ë³µì› ì™„ë£Œ!");
                        closeSettingsModal();
                        render();
                    } else throw new Error("ì˜¬ë°”ë¥´ì§€ ì•Šì€ íŒŒì¼");
                } catch (err) { alert("ë³µì› ì‹¤íŒ¨: " + err.message); }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        // --- Firebase Logic ---
        async function initData() {
            if (!db) { render(); return; }
            const docRef = doc(db, "trips", "shared_schedule");
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    scheduleData = data.data || initialData.schedule;
                    wishlistData = data.wishlist || [];
                    isDataLoadedFromServer = true; 
                    updateStatus(true);
                    localStorage.setItem('trip_backup', JSON.stringify({data: scheduleData, wishlist: wishlistData}));
                } else {
                    if (!isDataLoadedFromServer) {
                        setDoc(docRef, { data: initialData.schedule, wishlist: [] });
                        isDataLoadedFromServer = true;
                    }
                }
                render();
                document.getElementById('loading').style.display = 'none';
            }, (error) => {
                console.error(error);
                updateStatus(false);
                const backup = localStorage.getItem('trip_backup');
                if (backup) {
                    const parsed = JSON.parse(backup);
                    scheduleData = parsed.data;
                    wishlistData = parsed.wishlist;
                    render();
                }
                document.getElementById('loading').style.display = 'none';
            });
        }

        function updateStatus(isOnline) {
            const badge = document.getElementById('liveBadge');
            const sync = document.getElementById('syncStatus');
            const saveBtn = document.getElementById('btnSave');
            if (isOnline) {
                badge.innerText = "LIVE";
                badge.className = "text-[10px] text-blue-500 bg-blue-50 px-1 rounded align-top animate-pulse";
                sync.innerHTML = `<i class="fa-solid fa-cloud text-green-500"></i> <span class="text-green-500">ì—°ê²°ë¨</span>`;
                if(saveBtn) saveBtn.disabled = false;
            } else {
                badge.innerText = "OFFLINE";
                badge.className = "text-[10px] text-red-500 bg-red-50 px-1 rounded align-top";
                sync.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i> <span class="text-red-500">ì—°ê²° ëŠê¹€</span>`;
                if(saveBtn) { saveBtn.disabled = true; saveBtn.innerText = "ì—°ê²° ëŒ€ê¸°ì¤‘..."; saveBtn.classList.add('bg-gray-400'); }
            }
        }

        async function saveData() {
            if (!db || !isDataLoadedFromServer) { alert("âš ï¸ ì„œë²„ì™€ ì—°ê²°ë˜ì§€ ì•Šì•„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            document.getElementById('syncStatus').innerHTML = `<i class="fa-solid fa-cloud-arrow-up text-orange-500"></i>`;
            try {
                await setDoc(doc(db, "trips", "shared_schedule"), { data: scheduleData, wishlist: wishlistData });
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); updateStatus(false); }
        }

        // --- UI Logic ---
        function switchTab(mode) {
            viewMode = mode;
            document.getElementById('dateNavWrapper').classList.toggle('hidden', mode !== 'list');
            const t1 = document.getElementById('tabList');
            const t2 = document.getElementById('tabWishlist');
            t1.className = mode === 'list' ? "flex-1 py-3 text-sm font-medium text-center text-red-500 border-b-2 border-red-500" : "flex-1 py-3 text-sm font-medium text-center text-gray-400";
            t2.className = mode === 'wishlist' ? "flex-1 py-3 text-sm font-medium text-center text-red-500 border-b-2 border-red-500" : "flex-1 py-3 text-sm font-medium text-center text-gray-400";
            render();
        }

        function render() {
            document.getElementById('wishlistCount').innerText = wishlistData.length;
            const container = document.getElementById('schedule-container');
            const fab = document.getElementById('fabAdd');
            if (viewMode === 'list') { renderNav(); renderSchedule(container); }
            else { renderWishlist(container); }
            fab.classList.remove('hidden');
        }

        function renderNav() {
            const container = document.getElementById('dateNav');
            container.innerHTML = '';
            scheduleData.forEach((dayData, idx) => {
                const btn = document.createElement('button');
                btn.className = `flex-none py-3 px-5 text-center transition-colors ${idx === currentDay ? 'active-tab' : 'inactive-tab'}`;
                btn.onclick = () => { currentDay = idx; render(); };
                btn.innerHTML = `<div class="text-xs mb-0.5">${dayData.city}</div><div class="text-sm">${dayData.date.split(' ')[0]}</div>`;
                container.appendChild(btn);
                if (idx === currentDay) setTimeout(() => btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }), 100);
            });
        }

        function renderSchedule(container) {
            const data = scheduleData[currentDay];
            let html = `<div class="animate-fade-in pb-16"><div class="mb-6 mt-2"><h2 class="text-2xl font-bold text-gray-800">${data.title}</h2><p class="text-sm text-gray-500 mt-1">${data.date} Â· ${data.items.length}ê°œì˜ ì¼ì •</p></div><div class="timeline-line"></div>`;
            if (data.items.length === 0) html += `<div class="pl-12 py-8 text-gray-400 text-sm">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. + ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.</div>`;
            data.items.forEach((item, index) => html += createCardHtml(item, index + 1, 'schedule'));
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderWishlist(container) {
            if (wishlistData.length === 0) { container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 animate-fade-in"><i class="fa-regular fa-heart text-4xl mb-3"></i><p>ë³´ê´€í•¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p></div>`; return; }
            let html = `<div class="mt-4 animate-fade-in grid grid-cols-1 gap-4">`;
            wishlistData.forEach(item => html += createCardHtml(item, null, 'wishlist'));
            html += `</div>`;
            container.innerHTML = html;
        }

        function createCardHtml(item, index, type) {
            let actionButtons = '';
            if (type === 'schedule') {
                actionButtons = `<div class="absolute top-3 right-3"><button onclick="openEditModal(${item.id}, 'schedule')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 hover:text-blue-600"><i class="fa-solid fa-pen"></i></button></div>`;
            } else if (type === 'wishlist') {
                actionButtons = `<div class="absolute top-3 right-3"><button onclick="openEditModal(${item.id}, 'wishlist')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 hover:text-blue-600"><i class="fa-solid fa-pen"></i></button></div>`;
            }
            const isTimeline = type === 'schedule';
            return `
                <div class="relative flex gap-4 mb-6 z-10 items-start group animate-fade-in">
                    ${isTimeline ? `<div class="flex-shrink-0 w-14 flex flex-col items-center"><div class="w-8 h-8 rounded-full ${item.isHighlight ? 'bg-red-500 text-white' : 'bg-white border-2 border-gray-200 text-gray-500'} shadow-sm flex items-center justify-center text-sm font-bold z-10 mb-1">${index}</div><span class="text-xs text-gray-400 font-mono">${item.time}</span></div>` 
                    : `<div class="flex-shrink-0 w-12 flex flex-col items-center pt-1"><div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center text-lg shadow-sm"><i class="fa-solid ${item.icon}"></i></div></div>`}
                    <div class="flex-1 bg-white rounded-xl p-4 shadow-sm border border-gray-100 relative overflow-hidden">
                        ${actionButtons}
                        <div class="flex justify-between items-start mb-1 pr-8"><h3 class="font-bold text-gray-800 text-lg leading-tight">${item.title}</h3></div>
                        <p class="text-xs text-gray-500 font-medium mb-2">${item.chnName || 'ì¤‘êµ­ì–´ ëª…ì¹­ ì—†ìŒ'}</p>
                        <p class="text-sm text-gray-600 leading-relaxed mb-3 line-clamp-2">${item.desc || ''}</p>
                        <div class="flex gap-2 mt-3 border-t border-gray-50 pt-3"><button onclick="openMapModal(${item.id})" class="flex-1 flex items-center justify-center gap-2 bg-blue-50 text-blue-600 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition"><i class="fa-solid fa-map-location-dot"></i> ì§€ë„ ë³´ê¸°</button></div>
                    </div>
                </div>`;
        }

        // Edit & Save Logic
        function handleAddButton() { openEditModal(null, viewMode === 'wishlist' ? 'wishlist' : 'schedule'); }
        
        function openEditModal(itemId, mode) {
            const form = document.getElementById('editForm');
            form.reset();
            document.getElementById('editItemMode').value = mode;
            document.getElementById('wishlistPicker').classList.add('hidden');
            
            const isWishlist = mode === 'wishlist';
            document.getElementById('editModalTitle').innerText = isWishlist ? "ë³´ê´€í•¨ ì¶”ê°€" : "ì¼ì • ì¶”ê°€";
            document.getElementById('wishlistImportSection').classList.toggle('hidden', isWishlist || itemId);
            document.getElementById('timeInputGroup').classList.toggle('hidden', isWishlist);
            document.getElementById('iconOnlyGroup').classList.toggle('hidden', !isWishlist);
            document.getElementById('btnDelete').classList.toggle('hidden', !itemId);

            if (itemId) {
                const item = isWishlist ? wishlistData.find(i => i.id === itemId) : scheduleData[currentDay].items.find(i => i.id === itemId);
                if (item) {
                    document.getElementById('editModalTitle').innerText = "ìˆ˜ì •í•˜ê¸°";
                    document.getElementById('editItemId').value = item.id;
                    document.getElementById('editTime').value = item.time || "10:00";
                    document.getElementById('editIcon').value = item.icon;
                    document.getElementById('editIconOnly').value = item.icon;
                    document.getElementById('editTitle').value = item.title;
                    document.getElementById('editChnName').value = item.chnName || '';
                    document.getElementById('editDesc').value = item.desc || '';
                    document.getElementById('editMapUrl').value = item.mapUrl || '';
                    document.getElementById('editLat').value = item.lat || '';
                    document.getElementById('editLng').value = item.lng || '';
                }
            } else {
                document.getElementById('editItemId').value = '';
                document.getElementById('editTime').value = "10:00";
            }
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        function toggleWishlistPicker() {
            const picker = document.getElementById('wishlistPicker');
            if (picker.classList.contains('hidden')) {
                picker.innerHTML = wishlistData.length ? '' : '<div class="text-center text-gray-400 text-xs py-2">ë¹„ì–´ìˆìŒ</div>';
                wishlistData.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-2 hover:bg-blue-50 rounded-lg cursor-pointer border-b border-gray-50";
                    div.onclick = () => fillFromWishlist(item);
                    div.innerHTML = `<div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid ${item.icon}"></i></div><div><div class="font-bold text-sm">${item.title}</div></div>`;
                    picker.appendChild(div);
                });
                picker.classList.remove('hidden');
            } else picker.classList.add('hidden');
        }

        function fillFromWishlist(item) {
            document.getElementById('editTitle').value = item.title;
            document.getElementById('editChnName').value = item.chnName || '';
            document.getElementById('editDesc').value = item.desc || '';
            document.getElementById('editIcon').value = item.icon;
            document.getElementById('editMapUrl').value = item.mapUrl || '';
            document.getElementById('editLat').value = item.lat || '';
            document.getElementById('editLng').value = item.lng || '';
            document.getElementById('wishlistPicker').classList.add('hidden');
        }

        function saveItem(e) {
            e.preventDefault();
            if (!isDataLoadedFromServer) { alert("ì—°ê²° ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."); return; }
            const idVal = document.getElementById('editItemId').value;
            const mode = document.getElementById('editItemMode').value;
            const itemData = {
                time: document.getElementById('editTime').value,
                icon: document.getElementById('editIcon').value,
                title: document.getElementById('editTitle').value,
                chnName: document.getElementById('editChnName').value,
                desc: document.getElementById('editDesc').value,
                mapUrl: document.getElementById('editMapUrl').value,
                lat: parseFloat(document.getElementById('editLat').value) || 0,
                lng: parseFloat(document.getElementById('editLng').value) || 0
            };
            const id = idVal ? parseInt(idVal) : Date.now();

            if (mode === 'wishlist') {
                const idx = wishlistData.findIndex(i => i.id === id);
                if (idx > -1) wishlistData[idx] = { ...wishlistData[idx], ...itemData, id };
                else wishlistData.push({ id, ...itemData });
            } else {
                const items = scheduleData[currentDay].items;
                const idx = items.findIndex(i => i.id === id);
                if (idx > -1) items[idx] = { ...items[idx], ...itemData, id };
                else items.push({ id, ...itemData, isHighlight: false });
                scheduleData[currentDay].items.sort((a, b) => a.time.localeCompare(b.time));
            }
            saveData().then(() => closeEditModal());
        }

        function deleteCurrentItem() {
            if (!isDataLoadedFromServer) return;
            const id = parseInt(document.getElementById('editItemId').value);
            const mode = document.getElementById('editItemMode').value;
            if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (mode === 'wishlist') wishlistData = wishlistData.filter(i => i.id !== id);
                else scheduleData[currentDay].items = scheduleData[currentDay].items.filter(i => i.id !== id);
                saveData().then(() => closeEditModal());
            }
        }

        function openMapModal(itemId) {
            let item = null;
            if (scheduleData[currentDay]) item = scheduleData[currentDay].items.find(i => i.id === itemId);
            if (!item) for(let d of scheduleData) { item = d.items.find(i => i.id === itemId); if(item) break; }
            if (!item) item = wishlistData.find(i => i.id === itemId);
            if(!item) return;
            modalTarget = item;
            document.getElementById('modalTitle').innerText = item.title;
            document.getElementById('modalChnName').innerText = item.chnName || 'ì—†ìŒ';
            const container = document.getElementById('mapActions');
            container.innerHTML = ''; 
            if(item.mapUrl) container.innerHTML += `<a href="${item.mapUrl}" target="_blank" class="flex items-center justify-between p-4 rounded-xl bg-gray-100 border border-gray-200 hover:bg-gray-200 transition mb-2"><span class="font-bold text-sm">ğŸ”— ì§€ë„ ë§í¬ ì—´ê¸°</span></a>`;
            if(item.lat && item.lng) {
                const gaodeLink = `https://uri.amap.com/marker?position=${item.lng},${item.lat}&name=${encodeURIComponent(item.chnName||item.title)}`;
                container.innerHTML += `<a href="${gaodeLink}" target="_blank" class="flex items-center justify-center gap-2 p-4 rounded-xl bg-blue-50 text-blue-700 border border-blue-100 hover:bg-blue-100 transition"><span class="font-bold text-sm">ğŸ“ ê³ ë•ì§€ë„ ì¢Œí‘œ</span></a>`;
            }
            const query = item.chnName || item.title;
            container.innerHTML += `<div class="mt-3 border-t border-gray-100 pt-3 grid grid-cols-2 gap-3"><a href="https://uri.amap.com/search?keyword=${encodeURIComponent(query)}" target="_blank" class="p-3 rounded-xl bg-white border border-gray-200 text-center text-sm font-bold text-blue-600">ê³ ë• ê²€ìƒ‰</a><a href="http://api.map.baidu.com/geocoder?address=${encodeURIComponent(query)}&output=html" target="_blank" class="p-3 rounded-xl bg-white border border-gray-200 text-center text-sm font-bold text-red-600">ë°”ì´ë‘ ê²€ìƒ‰</a></div>`;
            document.getElementById('mapModal').classList.remove('hidden');
        }
        function closeMapModal() { document.getElementById('mapModal').classList.add('hidden'); }
        function copyChnName() { if(modalTarget && modalTarget.chnName) navigator.clipboard.writeText(modalTarget.chnName).then(() => alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!')); }
        document.getElementById('mapModal').addEventListener('click', (e) => { if (e.target.id === 'mapModal') closeMapModal(); });

        initData();
    </script>
</body>
</html>
