<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- ğŸ“± ì•± ì„¤ì • -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>ì²­ë‘ & ì‹œì•ˆ ì—¬í–‰ (LIVE)</title>

    <!-- ìŠ¤íƒ€ì¼ ë° í°íŠ¸ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; padding-bottom: 100px; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); user-select: none; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .timeline-line { position: absolute; left: 28px; top: 20px; bottom: 0; width: 2px; bg-gray-200; z-index: 0; background-color: #e5e7eb; }
        .active-tab { border-bottom: 2px solid #ef4444; color: #ef4444; font-weight: 700; }
        .inactive-tab { color: #9ca3af; }
        
        /* Modal Animation */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 max-w-md mx-auto shadow-2xl min-h-screen relative">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-4 py-3 flex justify-between items-center bg-white border-b border-gray-100">
            <div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight">ì²­ë‘ & ì‹œì•ˆ ì—¬í–‰ <span class="text-[10px] text-blue-500 bg-blue-50 px-1 rounded align-top animate-pulse">LIVE</span></h1>
                <p class="text-xs text-gray-500 flex items-center gap-1">
                    <span id="totalDays">6ë°• 7ì¼</span>
                    <span id="syncStatus" class="text-gray-300 text-[10px] ml-2"><i class="fa-solid fa-circle-notch fa-spin"></i> ì—°ê²° ì¤‘...</span>
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleEditMode()" id="btnEditMode" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center transition hover:bg-gray-200"><i class="fa-solid fa-pen"></i></button>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="flex border-b border-gray-200 bg-white">
            <button onclick="switchTab('list')" class="flex-1 py-3 text-sm font-medium text-center text-red-500 border-b-2 border-red-500 transition" id="tabList">
                ğŸ“… ì¼ì •í‘œ
            </button>
            <button onclick="switchTab('wishlist')" class="flex-1 py-3 text-sm font-medium text-center text-gray-400 hover:text-gray-600 transition" id="tabWishlist">
                ğŸ’– ì¥ì†Œ ë³´ê´€í•¨ (<span id="wishlistCount">0</span>)
            </button>
        </div>

        <!-- Date Navigation (Only visible in List mode) -->
        <div id="dateNavWrapper" class="overflow-x-auto hide-scrollbar bg-white shadow-sm transition-all duration-300">
            <div class="flex px-2 min-w-max" id="dateNav"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="schedule-container" class="p-4 min-h-[60vh] pb-32">
        <!-- Content injected by JS -->
    </main>

    <!-- Floating Add Button -->
    <div id="fabAdd" class="fixed bottom-24 right-6 z-30 hidden">
        <button onclick="handleAddButton()" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition transform active:scale-90">
            <i class="fa-solid fa-plus text-2xl"></i>
        </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 font-medium">ì—¬í–‰ ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
    </div>

    <!-- Modals -->
    <!-- 1. Map Modal -->
    <div id="mapModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center px-6 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 animate-fade-in shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <div><h3 class="text-lg font-bold text-gray-900" id="modalTitle">ì¥ì†Œ</h3><p class="text-sm text-gray-500" id="modalChnName">ì¤‘êµ­ì–´</p></div>
                <button onclick="closeMapModal()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="mapActions" class="space-y-3"></div>
            <button onclick="copyChnName()" class="w-full mt-4 py-3 text-sm text-gray-600 bg-gray-50 border border-gray-200 rounded-xl font-medium hover:bg-gray-100 transition">
                <i class="fa-regular fa-copy mr-1"></i> ì¤‘êµ­ì–´ ì§€ëª… ë³µì‚¬
            </button>
        </div>
    </div>

    <!-- 2. Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center sm:px-4">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-slide-up sm:animate-fade-in h-[90vh] sm:h-auto overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="editModalTitle">ì¼ì • ì¶”ê°€</h3>
                <button onclick="closeEditModal()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>

            <!-- ğŸ”¥ Import from Wishlist Button (Only in Schedule Mode) -->
            <div id="wishlistImportSection" class="mb-6 hidden">
                <p class="text-xs font-bold text-gray-500 mb-2">ë¹ ë¥¸ ì¶”ê°€</p>
                <button onclick="toggleWishlistPicker()" class="w-full flex items-center justify-between bg-red-50 text-red-600 p-3 rounded-xl border border-red-100 hover:bg-red-100 transition">
                    <span class="font-bold text-sm"><i class="fa-solid fa-heart mr-2"></i>ë³´ê´€í•¨(ì°œ)ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
                
                <!-- Wishlist Picker Dropdown -->
                <div id="wishlistPicker" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-sm max-h-48 overflow-y-auto p-2 space-y-2">
                    <!-- Items injected by JS -->
                </div>
            </div>
            
            <form id="editForm" onsubmit="saveItem(event)" class="space-y-4">
                <input type="hidden" id="editItemId">
                <input type="hidden" id="editItemMode"> <!-- 'schedule' or 'wishlist' -->
                
                <!-- ì‹œê°„ (ë³´ê´€í•¨ ëª¨ë“œì—ì„  ìˆ¨ê¹€) -->
                <div class="grid grid-cols-3 gap-3" id="timeInputGroup">
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ì‹œê°„</label>
                        <input type="text" id="editTime" placeholder="10:00" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-center">
                    </div>
                    <div class="col-span-2">
                         <label class="block text-xs font-bold text-gray-500 mb-1">ì•„ì´ì½˜</label>
                         <select id="editIcon" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3">
                             <option value="fa-location-dot">ğŸ“ ì¥ì†Œ (ê¸°ë³¸)</option>
                             <option value="fa-utensils">ğŸ´ ì‹ì‚¬/ë§›ì§‘</option>
                             <option value="fa-hotel">ğŸ¨ ìˆ™ì†Œ/í˜¸í…”</option>
                             <option value="fa-plane">âœˆï¸ ê³µí•­/ë¹„í–‰</option>
                             <option value="fa-train">ğŸš„ ê¸°ì°¨ì—­</option>
                             <option value="fa-camera">ğŸ“· ê´€ê´‘ì§€</option>
                             <option value="fa-bag-shopping">ğŸ›ï¸ ì‡¼í•‘</option>
                             <option value="fa-coffee">â˜• ì¹´í˜/íœ´ì‹</option>
                         </select>
                    </div>
                </div>

                <!-- ì•„ì´ì½˜ë§Œ (ë³´ê´€í•¨ ëª¨ë“œìš©) -->
                <div id="iconOnlyGroup" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì•„ì´ì½˜</label>
                    <select id="editIconOnly" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3" onchange="document.getElementById('editIcon').value = this.value">
                         <option value="fa-location-dot">ğŸ“ ì¥ì†Œ (ê¸°ë³¸)</option>
                         <option value="fa-utensils">ğŸ´ ì‹ì‚¬/ë§›ì§‘</option>
                         <option value="fa-hotel">ğŸ¨ ìˆ™ì†Œ/í˜¸í…”</option>
                         <option value="fa-plane">âœˆï¸ ê³µí•­/ë¹„í–‰</option>
                         <option value="fa-train">ğŸš„ ê¸°ì°¨ì—­</option>
                         <option value="fa-camera">ğŸ“· ê´€ê´‘ì§€</option>
                         <option value="fa-bag-shopping">ğŸ›ï¸ ì‡¼í•‘</option>
                         <option value="fa-coffee">â˜• ì¹´í˜/íœ´ì‹</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì¥ì†Œëª… (í•œê¸€)</label>
                    <input type="text" id="editTitle" placeholder="ì˜ˆ: ë³‘ë§ˆìš©" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 font-medium" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì¥ì†Œëª… (ì¤‘êµ­ì–´) <span class="text-red-400 font-normal">*ì§€ë„ ê²€ìƒ‰ìš©</span></label>
                    <input type="text" id="editChnName" placeholder="ì˜ˆ: å…µé©¬ä¿‘" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì„¤ëª… / ë©”ëª¨</label>
                    <textarea id="editDesc" rows="3" placeholder="ì…ì¥ë£Œ, ì˜ˆì•½ë²ˆí˜¸ ë“± ë©”ëª¨" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3"></textarea>
                </div>

                <!-- ì§€ë„ ìƒì„¸ ì„¤ì • -->
                <div class="border border-gray-100 rounded-xl p-3 bg-gray-50">
                    <p class="text-xs font-bold text-gray-500 mb-2">ğŸ—ºï¸ ì§€ë„ ì„¤ì • (ì„ íƒì‚¬í•­)</p>
                    <div class="mb-3">
                        <label class="block text-[10px] text-gray-400 mb-1">ì§€ë„ ë§í¬ ì§ì ‘ ì…ë ¥ (URL)</label>
                        <input type="url" id="editMapUrl" placeholder="https://..." class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm">
                    </div>
                    <details class="text-xs text-gray-500">
                        <summary class="cursor-pointer py-1 hover:text-blue-500 transition">ì¢Œí‘œ ì§ì ‘ ì…ë ¥í•˜ê¸° (ìœ„ë„/ê²½ë„)</summary>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <input type="number" step="any" id="editLat" placeholder="ìœ„ë„(Lat)" class="bg-white border border-gray-200 rounded p-2">
                            <input type="number" step="any" id="editLng" placeholder="ê²½ë„(Lng)" class="bg-white border border-gray-200 rounded p-2">
                        </div>
                    </details>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-100 text-gray-600 py-3.5 rounded-xl font-bold text-base hover:bg-gray-200 transition">ì·¨ì†Œ</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-3.5 rounded-xl font-bold text-base shadow-lg hover:bg-blue-700 transition">ì €ì¥</button>
                </div>
                
                <div class="text-center pt-2">
                    <button type="button" onclick="deleteCurrentItem()" id="btnDelete" class="text-red-400 text-xs py-2 px-4 hover:text-red-600 transition hidden">
                        <i class="fa-solid fa-trash mr-1"></i> ì‚­ì œí•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scroll Top -->
    <div class="fixed bottom-6 right-6 z-20">
        <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="bg-white text-gray-800 w-10 h-10 rounded-full shadow border border-gray-200 flex items-center justify-center"><i class="fa-solid fa-arrow-up"></i></button>
    </div>

    <!-- ğŸ”¥ Firebase SDK ë° ë¡œì§ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --------------------------------------------------------------------
        // ğŸ”¥ [í•„ìˆ˜] Firebase Config 
        // --------------------------------------------------------------------
        const firebaseConfig = {
          apiKey: "AIzaSyDhjSgDBdNu8stWUlqQbCWU2YhZkczlj3o",
          authDomain: "mytrip-2025-2bc36.firebaseapp.com",
          projectId: "mytrip-2025-2bc36",
          storageBucket: "mytrip-2025-2bc36.firebasestorage.app",
          messagingSenderId: "119786186294",
          appId: "1:119786186294:web:724b3881fcc070096c9a97",
          measurementId: "G-LCQD1E1QL7"
        };
        // --------------------------------------------------------------------

        let app, db;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.getElementById('loading').style.display = 'none';
        }

        // Global Functions
        window.toggleEditMode = toggleEditMode;
        window.switchTab = switchTab;
        window.render = render;
        window.openMapModal = openMapModal;
        window.closeMapModal = closeMapModal;
        window.copyChnName = copyChnName;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.saveItem = saveItem;
        window.deleteCurrentItem = deleteCurrentItem;
        window.handleAddButton = handleAddButton;
        window.toggleWishlistPicker = toggleWishlistPicker;
        window.fillFromWishlist = fillFromWishlist;

        // Initial Data (Fallback)
        const initialData = {
            schedule: [
                { day: 1, date: "12.30 (í™”)", city: "ì²­ë‘", title: "ì¶œêµ­ ë° ì´ë™", items: [{ id: 101, time: "12:00", title: "ì‹œì•ˆ ì…´ì–‘ êµ­ì œê³µí•­", chnName: "è¥¿å®‰å’¸é˜³å›½é™…æœºåœº", lat: 34.447, lng: 108.751, desc: "ë„ì°© í›„ ë°”ë¡œ ì‹œì•ˆë¶ì—­ìœ¼ë¡œ ì´ë™", icon: "fa-plane-arrival" }] },
                { day: 2, date: "12.31 (ìˆ˜)", city: "ì²­ë‘", title: "íŒë‹¤ & ì¹´ìš´íŠ¸ë‹¤ìš´", items: [{ id: 201, time: "08:30", title: "ì²­ë‘ íŒë‹¤ ê¸°ì§€", chnName: "æˆéƒ½å¤§ç†ŠçŒ«ç¹è‚²ç ”ç©¶åŸºåœ°", lat: 30.733, lng: 104.146, desc: "íŒë‹¤ ê´€ëŒ", icon: "fa-paw" }] },
                { day: 3, date: "01.01 (ëª©)", city: "ì²­ë‘", title: "ì—¬ìœ ì™€ íë§", items: [] },
                { day: 4, date: "01.02 (ê¸ˆ)", city: "ì‹œì•ˆ", title: "ì‹œì•ˆ ì´ë™ & ì•¼ê²½", items: [] },
                { day: 5, date: "01.03 (í† )", city: "ì‹œì•ˆ", title: "ë³‘ë§ˆìš© & ì¥í•œê°€", items: [{ id: 501, time: "10:00", title: "ë³‘ë§ˆìš©ê°±", chnName: "ç§¦å§‹çš‡å…µé©¬ä¿‘åšç‰©é¦†", lat: 34.385, lng: 109.278, desc: "ì§„ì‹œí™©ì˜ êµ°ë‹¨", icon: "fa-person-military-pointing", isHighlight: true }] },
                { day: 6, date: "01.04 (ì¼)", city: "ì‹œì•ˆ", title: "ëŒ€ë‹¹ë¶ˆì•¼ì„±", items: [] },
                { day: 7, date: "01.05 (ì›”)", city: "ì‹œì•ˆ", title: "ê·€êµ­", items: [] }
            ],
            wishlist: [ // Sample Wishlist
                { id: 901, title: "ì²­ë‘ ë””ì¦ˆë‹ˆ", chnName: "æˆéƒ½è¿ªå£«å°¼", icon: "fa-star", desc: "ì‹¤ì œ ë””ì¦ˆë‹ˆëŠ” ì•„ë‹ˆê³  ìš´ë™ê¸°êµ¬ê°€ ìˆëŠ” í•«í”Œë ˆì´ìŠ¤" },
                { id: 902, title: "ìƒ¤ë¸Œìƒ¤ë¸Œ ë§›ì§‘", chnName: "ç«é”…åº—", icon: "fa-utensils", desc: "í˜„ì§€ì¸ ì¶”ì²œ ë§›ì§‘" }
            ]
        };

        // State
        let scheduleData = [];
        let wishlistData = [];
        let currentDay = 0;
        let viewMode = 'list'; // 'list' or 'wishlist'
        let isEditMode = false;
        let modalTarget = null;

        // --- Firebase Logic ---
        async function initData() {
            if (!db) { 
                scheduleData = initialData.schedule; 
                wishlistData = initialData.wishlist;
                render(); 
                return; 
            }
            const docRef = doc(db, "trips", "shared_schedule");
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    scheduleData = data.data || initialData.schedule; // Legacy support
                    wishlistData = data.wishlist || initialData.wishlist;
                    document.getElementById('syncStatus').innerHTML = `<i class="fa-solid fa-cloud text-green-500"></i> <span class="text-green-500">ì™„ë£Œ</span>`;
                } else {
                    scheduleData = initialData.schedule;
                    wishlistData = initialData.wishlist;
                    setDoc(docRef, { data: scheduleData, wishlist: wishlistData });
                }
                render();
                document.getElementById('loading').style.display = 'none';
            }, (error) => {
                console.error(error);
                document.getElementById('syncStatus').innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i>`;
                // Fallback to local data if online fails is complex in this structure, sticking to init data
                document.getElementById('loading').style.display = 'none';
            });
        }

        async function saveData() {
            if (!db) return;
            document.getElementById('syncStatus').innerHTML = `<i class="fa-solid fa-cloud-arrow-up text-orange-500"></i>`;
            try {
                await setDoc(doc(db, "trips", "shared_schedule"), { 
                    data: scheduleData,
                    wishlist: wishlistData 
                });
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
        }

        // --- UI Logic ---
        function switchTab(mode) {
            viewMode = mode;
            const tabList = document.getElementById('tabList');
            const tabWishlist = document.getElementById('tabWishlist');
            const dateNavWrapper = document.getElementById('dateNavWrapper');

            if (mode === 'list') {
                tabList.className = "flex-1 py-3 text-sm font-medium text-center text-red-500 border-b-2 border-red-500 transition";
                tabWishlist.className = "flex-1 py-3 text-sm font-medium text-center text-gray-400 hover:text-gray-600 transition";
                dateNavWrapper.classList.remove('hidden');
            } else {
                tabList.className = "flex-1 py-3 text-sm font-medium text-center text-gray-400 hover:text-gray-600 transition";
                tabWishlist.className = "flex-1 py-3 text-sm font-medium text-center text-red-500 border-b-2 border-red-500 transition";
                dateNavWrapper.classList.add('hidden');
            }
            render();
        }

        function render() {
            document.getElementById('wishlistCount').innerText = wishlistData.length;
            const container = document.getElementById('schedule-container');
            const fab = document.getElementById('fabAdd');

            if (viewMode === 'list') {
                renderNav();
                renderSchedule(container);
            } else {
                renderWishlist(container);
            }

            // FAB is visible in Edit Mode (List) OR Always in Wishlist
            if (viewMode === 'wishlist' || (viewMode === 'list' && isEditMode)) {
                fab.classList.remove('hidden');
            } else {
                fab.classList.add('hidden');
            }
        }

        function renderNav() {
            const container = document.getElementById('dateNav');
            container.innerHTML = '';
            scheduleData.forEach((dayData, idx) => {
                const btn = document.createElement('button');
                const isActive = idx === currentDay;
                btn.className = `flex-none py-3 px-5 text-center transition-colors ${isActive ? 'active-tab' : 'inactive-tab'}`;
                btn.onclick = () => { currentDay = idx; render(); };
                btn.innerHTML = `<div class="text-xs mb-0.5">${dayData.city}</div><div class="text-sm">${dayData.date.split(' ')[0]}</div>`;
                container.appendChild(btn);
                if (isActive) setTimeout(() => btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }), 100);
            });
        }

        function renderSchedule(container) {
            const data = scheduleData[currentDay];
            let html = `<div class="animate-fade-in pb-16"><div class="mb-6 mt-2"><h2 class="text-2xl font-bold text-gray-800">${data.title}</h2><p class="text-sm text-gray-500 mt-1">${data.date} Â· ${data.items.length}ê°œì˜ ì¼ì •</p></div><div class="timeline-line"></div>`;
            if (data.items.length === 0) html += `<div class="pl-12 py-8 text-gray-400 text-sm">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            data.items.forEach((item, index) => {
                html += createCardHtml(item, index + 1, 'schedule');
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderWishlist(container) {
            if (wishlistData.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 animate-fade-in"><i class="fa-regular fa-heart text-4xl mb-3"></i><p>ì €ì¥ëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p><p class="text-xs mt-2">+ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê°€ê³  ì‹¶ì€ ê³³ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p></div>`;
                return;
            }
            let html = `<div class="mt-4 animate-fade-in grid grid-cols-1 gap-4">`;
            wishlistData.forEach(item => {
                html += createCardHtml(item, null, 'wishlist');
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        function createCardHtml(item, index, type) {
            // Actions based on type
            let actionButtons = '';
            if (type === 'schedule') {
                if (isEditMode) {
                    actionButtons = `<div class="absolute inset-0 bg-white/90 z-20 flex items-center justify-center gap-3 backdrop-blur-[1px] animate-fade-in border-2 border-blue-100 rounded-xl">
                        <button onclick="openEditModal(${item.id}, 'schedule')" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow font-bold text-sm hover:bg-blue-600">ìˆ˜ì •</button>
                    </div>`;
                }
            } else {
                // Wishlist Item
                actionButtons = `<div class="absolute top-3 right-3 flex gap-2">
                    <button onclick="openEditModal(${item.id}, 'wishlist')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-blue-100 hover:text-blue-600"><i class="fa-solid fa-pen"></i></button>
                </div>`;
            }

            const isTimeline = type === 'schedule';
            
            return `
                <div class="relative flex gap-4 mb-6 z-10 items-start group animate-fade-in">
                    ${isTimeline ? `
                    <div class="flex-shrink-0 w-14 flex flex-col items-center">
                        <div class="w-8 h-8 rounded-full ${item.isHighlight ? 'bg-red-500 text-white shadow-red-200' : 'bg-white border-2 border-gray-200 text-gray-500'} shadow-sm flex items-center justify-center text-sm font-bold z-10 mb-1">${index}</div>
                        <span class="text-xs text-gray-400 font-mono">${item.time}</span>
                    </div>` : `
                    <div class="flex-shrink-0 w-12 flex flex-col items-center pt-1">
                        <div class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center text-lg shadow-sm"><i class="fa-solid ${item.icon}"></i></div>
                    </div>`}

                    <div class="flex-1 bg-white rounded-xl p-4 shadow-sm border border-gray-100 relative overflow-hidden">
                        ${actionButtons}
                        <div class="flex justify-between items-start mb-1 pr-8">
                            <h3 class="font-bold text-gray-800 text-lg leading-tight">${item.title}</h3>
                        </div>
                        <p class="text-xs text-gray-500 font-medium mb-2">${item.chnName || 'ì¤‘êµ­ì–´ ëª…ì¹­ ì—†ìŒ'}</p>
                        <p class="text-sm text-gray-600 leading-relaxed mb-3 line-clamp-2">${item.desc || ''}</p>
                        <div class="flex gap-2 mt-3 border-t border-gray-50 pt-3">
                            <button onclick="openMapModal(${item.id})" class="flex-1 flex items-center justify-center gap-2 bg-blue-50 text-blue-600 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition"><i class="fa-solid fa-map-location-dot"></i> ì§€ë„ ë³´ê¸°</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('btnEditMode');
            btn.className = `w-10 h-10 rounded-full flex items-center justify-center transition ${isEditMode ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`;
            render();
        }

        // --- Edit Modal & Add Logic ---
        function handleAddButton() {
            // Determine mode based on current view
            const mode = viewMode === 'wishlist' ? 'wishlist' : 'schedule';
            openEditModal(null, mode);
        }

        function openEditModal(itemId, mode) {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('editForm');
            const btnDelete = document.getElementById('btnDelete');
            const wishlistSection = document.getElementById('wishlistImportSection');
            const timeGroup = document.getElementById('timeInputGroup');
            const iconOnlyGroup = document.getElementById('iconOnlyGroup');
            
            // Reset
            form.reset();
            document.getElementById('wishlistPicker').classList.add('hidden');
            
            // Config based on Mode
            document.getElementById('editItemMode').value = mode;
            if (mode === 'wishlist') {
                document.getElementById('editModalTitle').innerText = "ë³´ê´€í•¨ì— ì¥ì†Œ ì¶”ê°€";
                wishlistSection.classList.add('hidden');
                timeGroup.classList.add('hidden');
                iconOnlyGroup.classList.remove('hidden');
            } else {
                document.getElementById('editModalTitle').innerText = "ì¼ì •ì— ì¶”ê°€";
                wishlistSection.classList.remove('hidden'); // Show Import Button
                timeGroup.classList.remove('hidden');
                iconOnlyGroup.classList.add('hidden');
            }

            // Load Data if editing
            if (itemId) {
                let item;
                if (mode === 'wishlist') {
                    item = wishlistData.find(i => i.id === itemId);
                } else {
                    const dayData = scheduleData[currentDay];
                    item = dayData.items.find(i => i.id === itemId);
                }

                if (item) {
                    document.getElementById('editModalTitle').innerText = "ìˆ˜ì •í•˜ê¸°";
                    document.getElementById('editItemId').value = item.id;
                    document.getElementById('editTime').value = item.time || "10:00";
                    document.getElementById('editIcon').value = item.icon;
                    document.getElementById('editIconOnly').value = item.icon;
                    document.getElementById('editTitle').value = item.title;
                    document.getElementById('editChnName').value = item.chnName || '';
                    document.getElementById('editDesc').value = item.desc || '';
                    document.getElementById('editMapUrl').value = item.mapUrl || '';
                    document.getElementById('editLat').value = item.lat || '';
                    document.getElementById('editLng').value = item.lng || '';
                    btnDelete.classList.remove('hidden');
                    
                    // If editing existing schedule item, hide import
                    if(mode === 'schedule') wishlistSection.classList.add('hidden');
                }
            } else {
                // Adding New
                document.getElementById('editItemId').value = '';
                document.getElementById('editTime').value = "10:00";
                btnDelete.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        // --- Wishlist Picker Logic ---
        function toggleWishlistPicker() {
            const picker = document.getElementById('wishlistPicker');
            if (picker.classList.contains('hidden')) {
                picker.innerHTML = '';
                if (wishlistData.length === 0) {
                    picker.innerHTML = '<div class="text-center text-gray-400 text-xs py-2">ë³´ê´€í•¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>';
                } else {
                    wishlistData.forEach(item => {
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-3 p-2 hover:bg-blue-50 rounded-lg cursor-pointer border-b border-gray-50 last:border-0";
                        div.onclick = () => fillFromWishlist(item);
                        div.innerHTML = `
                            <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid ${item.icon}"></i></div>
                            <div>
                                <div class="font-bold text-sm text-gray-800">${item.title}</div>
                                <div class="text-xs text-gray-400">${item.chnName || ''}</div>
                            </div>
                        `;
                        picker.appendChild(div);
                    });
                }
                picker.classList.remove('hidden');
            } else {
                picker.classList.add('hidden');
            }
        }

        function fillFromWishlist(item) {
            document.getElementById('editTitle').value = item.title;
            document.getElementById('editChnName').value = item.chnName || '';
            document.getElementById('editDesc').value = item.desc || '';
            document.getElementById('editIcon').value = item.icon;
            document.getElementById('editMapUrl').value = item.mapUrl || '';
            document.getElementById('editLat').value = item.lat || '';
            document.getElementById('editLng').value = item.lng || '';
            
            document.getElementById('wishlistPicker').classList.add('hidden');
            // Alert or visual feedback
            const btn = document.querySelector('#wishlistImportSection button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="text-green-600 font-bold"><i class="fa-solid fa-check mr-1"></i> ì…ë ¥ ì™„ë£Œ!</span>';
            setTimeout(() => btn.innerHTML = originalText, 1500);
        }

        // --- Save & Delete ---
        function saveItem(e) {
            e.preventDefault();
            const idVal = document.getElementById('editItemId').value;
            const mode = document.getElementById('editItemMode').value;
            
            const itemData = {
                time: document.getElementById('editTime').value,
                icon: document.getElementById('editIcon').value,
                title: document.getElementById('editTitle').value,
                chnName: document.getElementById('editChnName').value,
                desc: document.getElementById('editDesc').value,
                mapUrl: document.getElementById('editMapUrl').value,
                lat: parseFloat(document.getElementById('editLat').value) || 0,
                lng: parseFloat(document.getElementById('editLng').value) || 0
            };

            // Generate ID if new
            const id = idVal ? parseInt(idVal) : Date.now();

            if (mode === 'wishlist') {
                // Save to Wishlist
                const idx = wishlistData.findIndex(i => i.id === id);
                if (idx > -1) wishlistData[idx] = { ...wishlistData[idx], ...itemData, id };
                else wishlistData.push({ id, ...itemData });
            } else {
                // Save to Schedule
                const items = scheduleData[currentDay].items;
                const idx = items.findIndex(i => i.id === id);
                if (idx > -1) items[idx] = { ...items[idx], ...itemData, id };
                else items.push({ id, ...itemData, isHighlight: false });
                // Sort by time
                scheduleData[currentDay].items.sort((a, b) => a.time.localeCompare(b.time));
            }

            saveData().then(() => closeEditModal());
        }

        function deleteCurrentItem() {
            const idVal = document.getElementById('editItemId').value;
            const mode = document.getElementById('editItemMode').value;
            
            if (idVal && confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const id = parseInt(idVal);
                if (mode === 'wishlist') {
                    wishlistData = wishlistData.filter(i => i.id !== id);
                } else {
                    scheduleData[currentDay].items = scheduleData[currentDay].items.filter(i => i.id !== id);
                }
                saveData().then(() => closeEditModal());
            }
        }

        // --- Map Logic ---
        function openMapModal(itemId) {
            // Find item in schedule OR wishlist
            let item = null;
            // 1. Try current schedule
            if (scheduleData[currentDay]) {
                item = scheduleData[currentDay].items.find(i => i.id === itemId);
            }
            // 2. Try all schedule
            if (!item) {
                for(let d of scheduleData) {
                    item = d.items.find(i => i.id === itemId);
                    if(item) break;
                }
            }
            // 3. Try wishlist
            if (!item) {
                item = wishlistData.find(i => i.id === itemId);
            }
            
            if(!item) return;

            modalTarget = item;
            document.getElementById('modalTitle').innerText = item.title;
            document.getElementById('modalChnName').innerText = item.chnName || 'ì¤‘êµ­ì–´ ëª…ì¹­ ì—†ìŒ';
            
            const container = document.getElementById('mapActions');
            container.innerHTML = ''; 

            if(item.mapUrl) {
                container.innerHTML += `<a href="${item.mapUrl}" target="_blank" class="flex items-center justify-between p-4 rounded-xl bg-gray-100 border border-gray-200 hover:bg-gray-200 transition mb-2"><div class="flex items-center gap-3"><i class="fa-solid fa-link text-xl text-gray-500"></i><span class="font-bold text-sm">ì§€ë„ ë§í¬ ì—´ê¸°</span></div><i class="fa-solid fa-arrow-up-right-from-square text-xs text-gray-400"></i></a>`;
            }
            if(item.lat && item.lng) {
                const gaodeLink = `https://uri.amap.com/marker?position=${item.lng},${item.lat}&name=${encodeURIComponent(item.chnName||item.title)}`;
                container.innerHTML += `<a href="${gaodeLink}" target="_blank" class="flex items-center justify-center gap-2 p-4 rounded-xl bg-blue-50 text-blue-700 border border-blue-100 hover:bg-blue-100 transition"><img src="https://upload.wikimedia.org/wikipedia/commons/3/3a/Amap_logo.svg" class="w-6 h-6" alt="Amap"><span class="font-bold text-sm">ê³ ë•ì§€ë„ ì¢Œí‘œë¡œ ë³´ê¸°</span></a>`;
            }
            const query = item.chnName || item.title;
            const gaodeSearch = `https://uri.amap.com/search?keyword=${encodeURIComponent(query)}`;
            const baiduSearch = `http://api.map.baidu.com/geocoder?address=${encodeURIComponent(query)}&output=html&src=webapp.mytrip`;

            container.innerHTML += `<div class="mt-3 border-t border-gray-100 pt-3"><p class="text-[10px] text-gray-400 mb-2 text-center">- ì§€ëª…ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸° -</p><div class="grid grid-cols-2 gap-3"><a href="${gaodeSearch}" target="_blank" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white border border-gray-200 hover:bg-gray-50"><span class="text-xs text-gray-500 mb-1">ê³ ë•ì§€ë„ ê²€ìƒ‰</span><span class="font-bold text-blue-600 text-sm">Amap</span></a><a href="${baiduSearch}" target="_blank" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white border border-gray-200 hover:bg-gray-50"><span class="text-xs text-gray-500 mb-1">ë°”ì´ë‘ë§µ ê²€ìƒ‰</span><span class="font-bold text-red-600 text-sm">Baidu</span></a></div></div>`;

            document.getElementById('mapModal').classList.remove('hidden');
        }

        function closeMapModal() { document.getElementById('mapModal').classList.add('hidden'); }
        function copyChnName() { if(modalTarget && modalTarget.chnName) navigator.clipboard.writeText(modalTarget.chnName).then(() => alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!')); }
        document.getElementById('mapModal').addEventListener('click', (e) => { if (e.target.id === 'mapModal') closeMapModal(); });

        initData();
    </script>
</body>
</html>
