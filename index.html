<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- ğŸ“± ì•± ì„¤ì • -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>ì²­ë‘ & ì‹œì•ˆ ì—¬í–‰ (LIVE)</title>

    <!-- ìŠ¤íƒ€ì¼ ë° í°íŠ¸ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; padding-bottom: 100px; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); user-select: none; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .timeline-line { position: absolute; left: 28px; top: 20px; bottom: 0; width: 2px; bg-gray-200; z-index: 0; background-color: #e5e7eb; }
        .active-tab { border-bottom: 2px solid #ef4444; color: #ef4444; font-weight: 700; }
        .inactive-tab { color: #9ca3af; }
        .edit-mode-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 max-w-md mx-auto shadow-2xl min-h-screen relative">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="px-4 py-3 flex justify-between items-center bg-white border-b border-gray-100">
            <div>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight">ì²­ë‘ & ì‹œì•ˆ ì—¬í–‰ <span class="text-[10px] text-blue-500 bg-blue-50 px-1 rounded align-top animate-pulse">LIVE</span></h1>
                <p class="text-xs text-gray-500 flex items-center gap-1">
                    <span id="totalDays">6ë°• 7ì¼</span>
                    <span id="syncStatus" class="text-gray-300 text-[10px] ml-2"><i class="fa-solid fa-circle-notch fa-spin"></i> ì—°ê²° ì¤‘...</span>
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleEditMode()" id="btnEditMode" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center transition hover:bg-gray-200"><i class="fa-solid fa-pen"></i></button>
            </div>
        </div>
        
        <div class="flex border-b border-gray-200 bg-white">
            <button onclick="viewMode='list'; render();" class="flex-1 py-3 text-sm font-medium text-center text-red-500 border-b-2 border-red-500 transition" id="tabList">ì¼ì • ëª©ë¡</button>
            <button onclick="viewMode='likes'; render();" class="flex-1 py-3 text-sm font-medium text-center text-gray-400 hover:text-gray-600 transition" id="tabLikes">ì°œí•œ ì¥ì†Œ (<span id="likeCount">0</span>)</button>
        </div>

        <div id="dateNavWrapper" class="overflow-x-auto hide-scrollbar bg-white shadow-sm">
            <div class="flex px-2 min-w-max" id="dateNav"></div>
        </div>
    </header>

    <main id="schedule-container" class="p-4 min-h-[60vh]"></main>

    <!-- Floating Add Button -->
    <div id="fabAdd" class="fixed bottom-24 right-6 z-30 hidden">
        <button onclick="openEditModal(null)" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition transform active:scale-90"><i class="fa-solid fa-plus text-2xl"></i></button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 font-medium">ì—¬í–‰ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        <p class="text-xs text-gray-400 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
    </div>

    <!-- Modals -->
    <!-- Map Modal -->
    <div id="mapModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center px-6 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 animate-fade-in shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <div><h3 class="text-lg font-bold text-gray-900" id="modalTitle">ì¥ì†Œ</h3><p class="text-sm text-gray-500" id="modalChnName">ì¤‘êµ­ì–´</p></div>
                <button onclick="closeMapModal()" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <a id="btnGaode" href="#" target="_blank" class="flex flex-col items-center justify-center p-4 rounded-xl bg-blue-50 text-blue-700 border border-blue-100"><i class="fa-solid fa-location-dot text-2xl mb-2"></i><span class="font-bold text-sm">ê³ ë•ì§€ë„</span></a>
                <a id="btnBaidu" href="#" target="_blank" class="flex flex-col items-center justify-center p-4 rounded-xl bg-red-50 text-red-700 border border-red-100"><i class="fa-solid fa-paw text-2xl mb-2"></i><span class="font-bold text-sm">ë°”ì´ë‘ë§µ</span></a>
            </div>
             <button onclick="copyChnName()" class="w-full mt-3 py-3 text-sm text-gray-600 bg-gray-100 rounded-lg font-medium"><i class="fa-regular fa-copy mr-1"></i> ì¤‘êµ­ì–´ ì§€ëª… ë³µì‚¬</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center sm:px-4">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-slide-up sm:animate-fade-in h-[85vh] sm:h-auto overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" id="editModalTitle">ì¼ì • ì¶”ê°€</h3>
                <button onclick="closeEditModal()" class="text-gray-400"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <form id="editForm" onsubmit="saveItem(event)" class="space-y-4">
                <input type="hidden" id="editItemId">
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">ì‹œê°„</label><input type="text" id="editTime" placeholder="10:00" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3" required></div>
                    <div class="col-span-2">
                         <label class="block text-xs font-bold text-gray-500 mb-1">ì•„ì´ì½˜</label>
                         <select id="editIcon" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3">
                             <option value="fa-location-dot">ğŸ“ ì¥ì†Œ</option><option value="fa-utensils">ğŸ´ ì‹ì‚¬</option><option value="fa-hotel">ğŸ¨ ìˆ™ì†Œ</option><option value="fa-plane">âœˆï¸ ë¹„í–‰ê¸°</option><option value="fa-train">ğŸš„ ê¸°ì°¨</option><option value="fa-camera">ğŸ“· ê´€ê´‘</option><option value="fa-bag-shopping">ğŸ›ï¸ ì‡¼í•‘</option>
                         </select>
                    </div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì¥ì†Œëª… (í•œê¸€)</label><input type="text" id="editTitle" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3" required></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì¥ì†Œëª… (ì¤‘êµ­ì–´)</label><input type="text" id="editChnName" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3"></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">ì„¤ëª…</label><textarea id="editDesc" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3"></textarea></div>
                <details class="text-xs text-gray-500"><summary class="cursor-pointer mb-2">ì¢Œí‘œ (ì„ íƒ)</summary><div class="grid grid-cols-2 gap-3"><input type="number" step="any" id="editLat" placeholder="ìœ„ë„" class="bg-gray-50 border p-2"><input type="number" step="any" id="editLng" placeholder="ê²½ë„" class="bg-gray-50 border p-2"></div></details>
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg mt-4">ì €ì¥ (ëª¨ë‘ì—ê²Œ ë°˜ì˜)</button>
                <button type="button" onclick="deleteCurrentItem()" id="btnDelete" class="w-full text-red-500 py-3 font-medium text-sm hidden">ì‚­ì œ</button>
            </form>
        </div>
    </div>

    <!-- Scroll Top -->
    <div class="fixed bottom-6 right-6 z-20">
        <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="bg-white text-gray-800 w-10 h-10 rounded-full shadow border border-gray-200 flex items-center justify-center"><i class="fa-solid fa-arrow-up"></i></button>
    </div>

    <!-- ğŸ”¥ Firebase SDK ë° ë¡œì§ -->
    <script type="module">
        // 1. Firebase SDK ê°€ì ¸ì˜¤ê¸° (CDN ë°©ì‹ ìœ ì§€)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // --------------------------------------------------------------------
        // ğŸ”¥ ì‚¬ìš©ìê°€ ì œê³µí•œ í‚¤ê°’ ì ìš© ì™„ë£Œ
        // --------------------------------------------------------------------
        const firebaseConfig = {
          apiKey: "AIzaSyDhjSgDBdNu8stWUlqQbCWU2YhZkczlj3o",
          authDomain: "mytrip-2025-2bc36.firebaseapp.com",
          projectId: "mytrip-2025-2bc36",
          storageBucket: "mytrip-2025-2bc36.firebasestorage.app",
          messagingSenderId: "119786186294",
          appId: "1:119786186294:web:724b3881fcc070096c9a97",
          measurementId: "G-LCQD1E1QL7"
        };
        // --------------------------------------------------------------------

        let app, db, analytics;
        
        // 3. Firebase ì´ˆê¸°í™” ë° ì—ëŸ¬ ì²˜ë¦¬
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            analytics = getAnalytics(app);
            console.log("Firebase ì—°ê²° ì‹œë„...");
        } catch (e) {
            console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
            alert("âš ï¸ ì—°ê²° ì˜¤ë¥˜\n\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            document.getElementById('loading').style.display = 'none';
        }

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        window.toggleEditMode = toggleEditMode;
        window.viewMode = 'list';
        window.render = render;
        window.openMapModal = openMapModal;
        window.closeMapModal = closeMapModal;
        window.copyChnName = copyChnName;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.saveItem = saveItem;
        window.deleteCurrentItem = deleteCurrentItem;

        // ê¸°ë³¸ ë°ì´í„° (ì„œë²„ê°€ ë¹„ì–´ìˆì„ ë•Œ ì‚¬ìš©)
        const initialScheduleData = [
            { day: 1, date: "12.30 (í™”)", city: "ì²­ë‘", title: "ì¶œêµ­ ë° ì´ë™", items: [{ id: 101, time: "12:00", title: "ì‹œì•ˆ ì…´ì–‘ êµ­ì œê³µí•­", chnName: "è¥¿å®‰å’¸é˜³å›½é™…æœºåœº", lat: 34.447, lng: 108.751, desc: "ë„ì°© í›„ ë°”ë¡œ ì‹œì•ˆë¶ì—­ìœ¼ë¡œ ì´ë™", icon: "fa-plane-arrival" }, { id: 102, time: "13:30", title: "ì‹œì•ˆë¶ì—­", chnName: "è¥¿å®‰åŒ—ç«™", lat: 34.376, lng: 108.939, desc: "Gì—´ì°¨ íƒ‘ìŠ¹ (ì‹œì•ˆâ†’ì²­ë‘)", icon: "fa-train" }, { id: 103, time: "19:30", title: "ì²­ë‘ í˜¸í…”", chnName: "æ˜¥ç†™è·¯", lat: 30.655, lng: 104.081, desc: "ì²´í¬ì¸ í›„ ì¶˜ì‹œë£¨ ì‚°ì±…", icon: "fa-hotel" }] },
            { day: 2, date: "12.31 (ìˆ˜)", city: "ì²­ë‘", title: "íŒë‹¤ & ì¹´ìš´íŠ¸ë‹¤ìš´", items: [{ id: 201, time: "08:30", title: "ì²­ë‘ íŒë‹¤ ê¸°ì§€", chnName: "æˆéƒ½å¤§ç†ŠçŒ«ç¹è‚²ç ”ç©¶åŸºåœ°", lat: 30.733, lng: 104.146, desc: "íŒë‹¤ ê´€ëŒ", icon: "fa-paw" }, { id: 204, time: "23:50", title: "ê¸ˆìœµì„¼í„° ìŒë‘¥ì´ë¹Œë”©", chnName: "å¤©åºœå›½é™…é‡‘èä¸­å¿ƒ", lat: 30.572, lng: 104.066, desc: "ìƒˆí•´ë§ì´ ì¹´ìš´íŠ¸ë‹¤ìš´", icon: "fa-champagne-glasses", isHighlight: true }] },
            { day: 3, date: "01.01 (ëª©)", city: "ì²­ë‘", title: "ì—¬ìœ ì™€ íë§", items: [{ id: 301, time: "10:00", title: "ì¸ë¯¼ê³µì›", chnName: "äººæ°‘å…¬å›­", lat: 30.660, lng: 104.056, desc: "ì°¨ í•œì”ê³¼ ê·€ì²­ì†Œ", icon: "fa-mug-hot" }] },
            { day: 4, date: "01.02 (ê¸ˆ)", city: "ì‹œì•ˆ", title: "ì‹œì•ˆ ì´ë™ & ì•¼ê²½", items: [{ id: 401, time: "09:00", title: "ì²­ë‘ë™ì—­", chnName: "æˆéƒ½ä¸œç«™", lat: 30.629, lng: 104.141, desc: "ì‹œì•ˆìœ¼ë¡œ ì´ë™", icon: "fa-train" }, { id: 402, time: "15:00", title: "ì¢…ë£¨ & ê³ ë£¨", chnName: "è¥¿å®‰é’Ÿæ¥¼", lat: 34.260, lng: 108.947, desc: "ì‹œì•ˆ ëœë“œë§ˆí¬", icon: "fa-bell" }] },
            { day: 5, date: "01.03 (í† )", city: "ì‹œì•ˆ", title: "ë³‘ë§ˆìš© & ì¥í•œê°€", items: [{ id: 501, time: "10:00", title: "ë³‘ë§ˆìš©ê°±", chnName: "ç§¦å§‹çš‡å…µé©¬ä¿‘åšç‰©é¦†", lat: 34.385, lng: 109.278, desc: "ì§„ì‹œí™©ì˜ êµ°ë‹¨", icon: "fa-person-military-pointing", isHighlight: true }] },
            { day: 6, date: "01.04 (ì¼)", city: "ì‹œì•ˆ", title: "ëŒ€ë‹¹ë¶ˆì•¼ì„±", items: [{ id: 603, time: "19:00", title: "ëŒ€ë‹¹ë¶ˆì•¼ì„±", chnName: "å¤§å”ä¸å¤œåŸ", lat: 34.213, lng: 108.962, desc: "ìµœê³ ì˜ ì•¼ê²½", icon: "fa-camera", isHighlight: true }] },
            { day: 7, date: "01.05 (ì›”)", city: "ì‹œì•ˆ", title: "ê·€êµ­", items: [{ id: 702, time: "14:00", title: "ê³µí•­ ì´ë™", chnName: "è¥¿å®‰å’¸é˜³å›½é™…æœºåœº", lat: 34.447, lng: 108.751, desc: "ê·€êµ­", icon: "fa-plane-departure" }] }
        ];

        // ìƒíƒœ ë³€ìˆ˜
        let scheduleData = [];
        let currentDay = 0;
        let isEditMode = false;
        let favorites = JSON.parse(localStorage.getItem('tripFavorites_final')) || [];
        let modalTarget = null;

        // --- ì‹¤ì‹œê°„ ë™ê¸°í™” ë¡œì§ ---
        async function initData() {
            if (!db) {
                // ì„¤ì •í‚¤ê°€ ì—†ì–´ì„œ dbê°€ ì´ˆê¸°í™” ì•ˆëœ ê²½ìš°
                scheduleData = initialScheduleData;
                render();
                return;
            }

            // Firestoreì˜ 'trips' ì»¬ë ‰ì…˜ ì•ˆì— 'shared_schedule'ì´ë¼ëŠ” ë¬¸ì„œ í•˜ë‚˜ë¥¼ êµ¬ë…í•©ë‹ˆë‹¤.
            const docRef = doc(db, "trips", "shared_schedule");

            onSnapshot(docRef, (doc) => {
                const source = doc.metadata.hasPendingWrites ? "Local" : "Server";
                console.log("ë°ì´í„° ìˆ˜ì‹  ìœ„ì¹˜: " + source);
                
                if (doc.exists()) {
                    // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    scheduleData = doc.data().data;
                    updateSyncStatus("ë™ê¸°í™” ì™„ë£Œ", "text-green-500");
                } else {
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´(ìµœì´ˆ ì‹¤í–‰) ê¸°ë³¸ ë°ì´í„°ë¥¼ ì„œë²„ì— ì”ë‹ˆë‹¤.
                    scheduleData = initialScheduleData;
                    setDoc(docRef, { data: initialScheduleData });
                    updateSyncStatus("ì´ˆê¸°í™” ì¤‘...", "text-blue-500");
                }
                render();
                document.getElementById('loading').style.display = 'none';
            }, (error) => {
                console.error("ë™ê¸°í™” ì—ëŸ¬:", error);
                // ê¶Œí•œ ì—ëŸ¬ì¼ í™•ë¥ ì´ ë†’ìŒ (1ë‹¨ê³„ Firestore ìƒì„± ì•ˆí–ˆì„ ì‹œ)
                if(error.code === 'permission-denied') {
                    alert("âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ê¶Œí•œ ì˜¤ë¥˜!\n\nFirebase ì½˜ì†”ì—ì„œ 'Firestore Database'ë¥¼ ìƒì„±í•˜ê³  'í…ŒìŠ¤íŠ¸ ëª¨ë“œ'ë¡œ ì„¤ì •í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
                updateSyncStatus("ì—°ê²° ëŠê¹€", "text-red-500");
                scheduleData = initialScheduleData; // ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ë°ì´í„° ì‚¬ìš©
                render();
                document.getElementById('loading').style.display = 'none';
            });
        }

        function updateSyncStatus(msg, colorClass) {
            const el = document.getElementById('syncStatus');
            el.innerHTML = `<i class="fa-solid fa-cloud"></i> ${msg}`;
            el.className = `text-[10px] ml-2 ${colorClass}`;
        }

        async function saveData() {
            if (!db) return;
            updateSyncStatus("ì €ì¥ ì¤‘...", "text-orange-500");
            try {
                await setDoc(doc(db, "trips", "shared_schedule"), { data: scheduleData });
                // ì €ì¥ì´ ì™„ë£Œë˜ë©´ onSnapshotì´ ìë™ìœ¼ë¡œ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            } catch (e) {
                console.error("ì €ì¥ ì‹¤íŒ¨: ", e);
                alert("ì €ì¥ ì‹¤íŒ¨! ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        // --- UI ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼) ---
        function render() {
            const navContainer = document.getElementById('dateNav');
            const mainContainer = document.getElementById('schedule-container');
            const tabList = document.getElementById('tabList');
            const tabLikes = document.getElementById('tabLikes');
            
            document.getElementById('likeCount').innerText = favorites.length;

            if (window.viewMode === 'list') {
                tabList.className = "flex-1 py-3 text-sm font-medium text-center text-red-500 border-b-2 border-red-500 transition";
                tabLikes.className = "flex-1 py-3 text-sm font-medium text-center text-gray-400 hover:text-gray-600 transition";
                document.getElementById('dateNavWrapper').classList.remove('hidden');
                renderNav();
                renderList(mainContainer);
            } else {
                tabList.className = "flex-1 py-3 text-sm font-medium text-center text-gray-400 hover:text-gray-600 transition";
                tabLikes.className = "flex-1 py-3 text-sm font-medium text-center text-red-500 border-b-2 border-red-500 transition";
                document.getElementById('dateNavWrapper').classList.add('hidden');
                renderLikes(mainContainer);
            }

            const fab = document.getElementById('fabAdd');
            if (isEditMode && window.viewMode === 'list') fab.classList.remove('hidden');
            else fab.classList.add('hidden');
        }

        function renderNav() {
            const container = document.getElementById('dateNav');
            container.innerHTML = '';
            scheduleData.forEach((dayData, idx) => {
                const btn = document.createElement('button');
                const isActive = idx === currentDay;
                btn.className = `flex-none py-3 px-5 text-center transition-colors ${isActive ? 'active-tab' : 'inactive-tab'}`;
                btn.onclick = () => { currentDay = idx; render(); };
                btn.innerHTML = `<div class="text-xs mb-0.5">${dayData.city}</div><div class="text-sm">${dayData.date.split(' ')[0]}</div>`;
                container.appendChild(btn);
                if (isActive) setTimeout(() => btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }), 100);
            });
        }

        function renderList(container) {
            const data = scheduleData[currentDay];
            let html = `<div class="animate-fade-in pb-16"><div class="mb-6 mt-2"><h2 class="text-2xl font-bold text-gray-800">${data.title}</h2><p class="text-sm text-gray-500 mt-1">${data.date} Â· ${data.items.length}ê°œì˜ ì¼ì •</p></div><div class="timeline-line"></div>`;

            if (data.items.length === 0) html += `<div class="pl-12 py-8 text-gray-400 text-sm">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

            data.items.forEach((item, index) => {
                const isLiked = favorites.includes(item.id);
                html += createCardHtml(item, index + 1, isLiked);
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderLikes(container) {
            const allItems = scheduleData.flatMap(d => d.items);
            const likedItems = allItems.filter(item => favorites.includes(item.id));
            if (likedItems.length === 0) return container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400 animate-fade-in"><i class="fa-regular fa-heart text-4xl mb-3"></i><p>ì €ì¥ëœ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            let html = `<div class="mt-4 animate-fade-in"><h2 class="text-xl font-bold mb-4 px-1">ì €ì¥ëœ ì¥ì†Œ (${likedItems.length})</h2><div class="space-y-4">`;
            likedItems.forEach(item => html += createCardHtml(item, null, true));
            html += `</div></div>`;
            container.innerHTML = html;
        }

        function createCardHtml(item, index, isLiked) {
            const editOverlay = isEditMode ? `<div class="absolute inset-0 bg-white/80 z-20 flex items-center justify-center gap-3 backdrop-blur-[1px] animate-fade-in border-2 border-blue-100 rounded-xl"><button onclick="openEditModal(${item.id})" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow font-bold text-sm">ìˆ˜ì •</button><button onclick="deleteItem(${item.id})" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow font-bold text-sm">ì‚­ì œ</button></div>` : '';
            const likeBtn = !isEditMode ? `<button onclick="toggleLike(${item.id})" class="w-8 h-8 flex items-center justify-center -mr-2 -mt-2 heart-anim"><i class="${isLiked ? 'fa-solid text-red-500' : 'fa-regular text-gray-400'} fa-heart text-lg"></i></button>` : '';
            
            return `
                <div class="relative flex gap-4 mb-8 z-10 items-start group ${isEditMode ? 'edit-mode-shake' : ''}">
                    <div class="flex-shrink-0 w-14 flex flex-col items-center"><div class="w-8 h-8 rounded-full ${item.isHighlight ? 'bg-red-500 text-white shadow-red-200' : 'bg-white border-2 border-gray-200 text-gray-500'} shadow-sm flex items-center justify-center text-sm font-bold z-10 mb-1">${index ? index : `<i class="fa-solid ${item.icon} text-xs"></i>`}</div>${index ? `<span class="text-xs text-gray-400 font-mono">${item.time}</span>` : ''}</div>
                    <div class="flex-1 bg-white rounded-xl p-4 shadow-sm border border-gray-100 btn-press relative overflow-hidden">
                        ${editOverlay}
                        <div class="flex justify-between items-start mb-1"><h3 class="font-bold text-gray-800 text-lg leading-tight">${item.title}</h3>${likeBtn}</div>
                        <p class="text-xs text-gray-500 font-medium mb-2">${item.chnName || 'ì¤‘êµ­ì–´ ì§€ëª… ì—†ìŒ'}</p>
                        <p class="text-sm text-gray-600 leading-relaxed mb-3 line-clamp-2">${item.desc}</p>
                        <div class="flex gap-2 mt-3 border-t border-gray-50 pt-3"><button onclick="openMapModal('${item.title}', '${item.chnName || item.title}', ${item.lat || 0}, ${item.lng || 0})" class="flex-1 flex items-center justify-center gap-2 bg-blue-50 text-blue-600 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition"><i class="fa-solid fa-map-location-dot"></i> ì§€ë„ ë³´ê¸°</button></div>
                    </div>
                </div>
            `;
        }

        // Actions
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('btnEditMode');
            btn.className = `w-10 h-10 rounded-full flex items-center justify-center transition ${isEditMode ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`;
            render();
        }

        function openEditModal(itemId) {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('editForm');
            const btnDelete = document.getElementById('btnDelete');
            if (itemId) {
                const dayData = scheduleData[currentDay];
                const item = dayData.items.find(i => i.id === itemId);
                if (!item) return;
                document.getElementById('editModalTitle').innerText = "ì¼ì • ìˆ˜ì •";
                document.getElementById('editItemId').value = item.id;
                document.getElementById('editTime').value = item.time;
                document.getElementById('editIcon').value = item.icon;
                document.getElementById('editTitle').value = item.title;
                document.getElementById('editChnName').value = item.chnName || '';
                document.getElementById('editDesc').value = item.desc;
                document.getElementById('editLat').value = item.lat || '';
                document.getElementById('editLng').value = item.lng || '';
                btnDelete.classList.remove('hidden');
            } else {
                document.getElementById('editModalTitle').innerText = "ìƒˆ ì¼ì • ì¶”ê°€";
                form.reset();
                document.getElementById('editItemId').value = '';
                document.getElementById('editTime').value = "12:00";
                btnDelete.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        function saveItem(e) {
            e.preventDefault();
            const idVal = document.getElementById('editItemId').value;
            const itemData = {
                time: document.getElementById('editTime').value,
                icon: document.getElementById('editIcon').value,
                title: document.getElementById('editTitle').value,
                chnName: document.getElementById('editChnName').value,
                desc: document.getElementById('editDesc').value,
                lat: parseFloat(document.getElementById('editLat').value) || 34.26,
                lng: parseFloat(document.getElementById('editLng').value) || 108.94
            };

            if (idVal) {
                const id = parseInt(idVal);
                const items = scheduleData[currentDay].items;
                const idx = items.findIndex(i => i.id === id);
                if (idx > -1) items[idx] = { ...items[idx], ...itemData };
            } else {
                scheduleData[currentDay].items.push({ id: Date.now(), ...itemData, isHighlight: false });
            }
            scheduleData[currentDay].items.sort((a, b) => a.time.localeCompare(b.time));
            
            // Save to Cloud
            saveData().then(() => {
                closeEditModal();
            });
        }

        function deleteCurrentItem() {
            const idVal = document.getElementById('editItemId').value;
            if (idVal) {
                 if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ëª¨ë‘ì—ê²Œ ë°˜ì˜ë©ë‹ˆë‹¤)')) {
                     scheduleData[currentDay].items = scheduleData[currentDay].items.filter(i => i.id !== parseInt(idVal));
                     saveData().then(() => closeEditModal());
                 }
            }
        }

        function toggleLike(id) { // Local only
            if (favorites.includes(id)) favorites = favorites.filter(fid => fid !== id);
            else favorites.push(id);
            localStorage.setItem('tripFavorites_final', JSON.stringify(favorites));
            render();
        }

        // Maps
        function openMapModal(title, chnName, lat, lng) {
            modalTarget = { title, chnName };
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalChnName').innerText = chnName;
            document.getElementById('btnGaode').href = `https://uri.amap.com/marker?position=${lng},${lat}&name=${encodeURIComponent(chnName)}`;
            document.getElementById('btnBaidu').href = `http://api.map.baidu.com/marker?location=${lat},${lng}&title=${encodeURIComponent(chnName)}&content=${encodeURIComponent(title)}&output=html`;
            document.getElementById('mapModal').classList.remove('hidden');
        }
        function closeMapModal() { document.getElementById('mapModal').classList.add('hidden'); }
        function copyChnName() { if(modalTarget && modalTarget.chnName) navigator.clipboard.writeText(modalTarget.chnName).then(() => alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!')); }
        document.getElementById('mapModal').addEventListener('click', (e) => { if (e.target.id === 'mapModal') closeMapModal(); });
        
        // Start
        initData();
    </script>
    
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
    </style>
</body>
</html>
